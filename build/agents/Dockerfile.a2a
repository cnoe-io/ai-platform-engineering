# ---------- Stage 1: Build dependencies ----------
FROM python:3.13-slim AS builder

ARG AGENT_NAME
ARG AGENT_PACKAGE

RUN if [ -z "$AGENT_NAME" ]; then \
    echo "Error: AGENT_NAME build argument is required but not set."; \
    exit 1; \
    fi

# Install system dependencies and uv in one layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    && pip install uv \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy only the necessary directories for the agent
COPY --chown=root:root ./ai_platform_engineering/utils /app/ai_platform_engineering/utils/
COPY --chown=root:root ./ai_platform_engineering/agents/${AGENT_NAME} /app/ai_platform_engineering/agents/agent/

# Set working directory to the agent directory
WORKDIR /app/ai_platform_engineering/agents/agent

# Create README.md if not present (due to .dockerignore)
RUN [ ! -f "README.md" ] && echo "# README" > README.md || true

# Install dependencies into venv (no dev deps) using committed lock file
# --locked ensures we use the existing uv.lock without modification
# Increase timeout for large packages (e.g., pyarrow 39MB)
RUN --mount=type=cache,target=/root/.cache/uv \
    UV_HTTP_TIMEOUT=300 uv sync --locked --no-dev

# ---------- Stage 2: Final runtime image ----------
FROM python:3.13-slim

ARG AGENT_NAME
ARG AGENT_PACKAGE

RUN if [ -z "$AGENT_NAME" ]; then \
    echo "Error: AGENT_NAME build argument is required but not set."; \
    exit 1; \
    fi

# Install only runtime dependencies
# Note: curl and unzip are needed for AWS CLI installation, jq for JSON processing
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    unzip \
    jq \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install AWS CLI v2 (architecture-aware)
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then \
        curl -sL "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o "awscliv2.zip"; \
    else \
        curl -sL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"; \
    fi && \
    unzip -q awscliv2.zip && \
    ./aws/install && \
    rm -rf awscliv2.zip aws

# Install kubectl (architecture-aware)
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then \
        KUBECTL_ARCH="arm64"; \
    else \
        KUBECTL_ARCH="amd64"; \
    fi && \
    curl -sLO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/${KUBECTL_ARCH}/kubectl" && \
    chmod +x kubectl && \
    mv kubectl /usr/local/bin/kubectl

# Install GitHub CLI (architecture-aware)
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then \
        GH_ARCH="arm64"; \
    else \
        GH_ARCH="amd64"; \
    fi && \
    GH_VERSION="2.63.2" && \
    curl -sL "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_${GH_ARCH}.tar.gz" -o gh.tar.gz && \
    tar -xzf gh.tar.gz && \
    mv gh_${GH_VERSION}_linux_${GH_ARCH}/bin/gh /usr/local/bin/gh && \
    rm -rf gh.tar.gz gh_${GH_VERSION}_linux_${GH_ARCH}

# Create appuser in final image
RUN groupadd -r appuser && useradd -r -g appuser -u 1001 -m appuser

# Set working directory to the agent directory
WORKDIR /app/ai_platform_engineering/agents/agent

# Set AGENT_PACKAGE to AGENT_NAME if not provided, then set env vars for uv & PATH
ENV AGENT_PACKAGE_NAME=${AGENT_PACKAGE:-${AGENT_NAME}} \
    UV_PROJECT_ENVIRONMENT=/app/ai_platform_engineering/agents/agent/.venv \
    PATH="/app/ai_platform_engineering/agents/agent/.venv/bin:${PATH}" \
    PYTHONPATH="/app" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Copy venv & code from builder (maintain directory structure)
COPY --from=builder --chown=appuser:appuser /app /app

USER appuser

EXPOSE 8000

CMD ["sh", "-c", "exec python -m agent_${AGENT_PACKAGE_NAME} --host 0.0.0.0 --port 8000"]
