name: "[Tests][Helm] Helm Chart"
description: "Test Helm charts"

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'charts/**'
      - '.github/workflows/helm-chart-test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'charts/**'
      - '.github/workflows/helm-chart-test.yml'
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  helm-chart-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        helm-version: ['v3.18.2', 'v3.17.3']

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: ${{ matrix.helm-version }}

    - name: Add required Helm repositories
      run: |
        helm repo add milvus https://zilliztech.github.io/milvus-helm/
        helm repo add neo4j https://helm.neo4j.com/neo4j
        helm repo add external-secrets https://charts.external-secrets.io
        helm repo update

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Helm for OCI authentication
      run: |
        echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Install Helm dependencies for rag-stack
      run: |
        cd charts/rag-stack
        helm dependency update

    - name: Install Helm dependencies for ai-platform-engineering
      run: |
        cd charts/ai-platform-engineering
        helm dependency update

    - name: Lint rag-stack chart
      run: |
        helm lint charts/rag-stack

    - name: Lint ai-platform-engineering chart
      run: |
        helm lint charts/ai-platform-engineering

    - name: Test rag-stack installation (dry-run)
      run: |
        cd charts/rag-stack
        helm template test-rag-stack . \
          --debug \
          --set milvus.cluster.enabled=false \
          --set milvus.etcd.replicaCount=1 \
          --set milvus.pulsar.enabled=false \
          --set milvus.minio.mode=standalone \
          --set rag-webui.ingress.enabled=true \
          --set "rag-webui.ingress.hosts[0].host=example.com"

    - name: Test ai-platform-engineering installation (dry-run) - All services
      run: |
        cd charts/ai-platform-engineering
        helm template test-all-services . \
          --debug \
          --set tags.complete=true \
          --set rag-stack.milvus.cluster.enabled=false \
          --set rag-stack.milvus.etcd.replicaCount=1 \
          --set rag-stack.milvus.pulsar.enabled=false \
          --set rag-stack.milvus.minio.mode=standalone

    - name: Test ai-platform-engineering installation (dry-run) - Basic configuration
      run: |
        cd charts/ai-platform-engineering
        helm template test-basic . \
          --debug \
          --set tags.basic=true \
          --set tags.rag-stack=false

    - name: Test ai-platform-engineering installation (dry-run) - Minimal configuration
      run: |
        cd charts/ai-platform-engineering
        helm template test-minimal . \
          --debug \
          --set supervisor-agent.enabled=true \
          --set agent-argocd.enabled=false \
          --set agent-github.enabled=false \
          --set tags.rag-stack=false

    - name: Test rag-stack with different configurations
      run: |
        cd charts/rag-stack

        # Test with all services disabled except webui
        helm template test-minimal . \
          --set milvus.enabled=false \
          --set rag-server.enabled=false \
          --set agent-ontology.enabled=false \
          --set rag-redis.enabled=false \
          --set rag-webui.enabled=true \
          --set neo4j.enabled=false

        # Test with custom resource limits
        helm template test-resources . \
          --set milvus.cluster.enabled=false \
          --set milvus.etcd.replicaCount=1 \
          --set milvus.pulsar.enabled=false \
          --set milvus.minio.mode=standalone \
          --set rag-webui.resources.limits.cpu=1000m \
          --set rag-webui.resources.limits.memory=1Gi \
          --set rag-server.resources.limits.cpu=1000m \
          --set rag-server.resources.limits.memory=1Gi

    - name: Test with different resource configurations
      run: |
        cd charts/ai-platform-engineering

        # Test with custom resource limits
        helm template test-resources . \
          --set tags.basic=true \
          --set tags.rag-stack=true \
          --set rag-stack.milvus.cluster.enabled=false \
          --set rag-stack.milvus.etcd.replicaCount=1 \
          --set rag-stack.milvus.pulsar.enabled=false \
          --set rag-stack.milvus.minio.mode=standalone \
          --set rag-stack.rag-webui.resources.limits.cpu=1000m \
          --set rag-stack.rag-webui.resources.limits.memory=1Gi \
          --set rag-stack.rag-server.resources.limits.cpu=1000m \
          --set rag-stack.rag-server.resources.limits.memory=1Gi

    - name: Test ingress configurations
      run: |
        cd charts/rag-stack

        # Test with ingress enabled
        helm template test-ingress . \
          --set milvus.cluster.enabled=false \
          --set milvus.etcd.replicaCount=1 \
          --set milvus.pulsar.enabled=false \
          --set milvus.minio.mode=standalone \
          --set rag-webui.ingress.enabled=true \
          --set rag-webui.ingress.className=nginx \
          --set "rag-webui.ingress.annotations.kubernetes\.io/tls-acme=true" \
          --set "rag-webui.ingress.annotations.cert-manager\.io/cluster-issuer=letsencrypt-prod" \
          --set "rag-webui.ingress.hosts[0].host=rag.example.com" \
          --set "rag-webui.ingress.tls[0].secretName=rag-tls" \
          --set "rag-webui.ingress.tls[0].hosts[0]=rag.example.com"

    - name: Test with different storage classes
      run: |
        cd charts/ai-platform-engineering

        # Test with custom storage class
        helm template test-storage . \
          --set tags.rag-stack=true \
          --set rag-stack.milvus.cluster.enabled=false \
          --set rag-stack.milvus.etcd.replicaCount=1 \
          --set rag-stack.milvus.pulsar.enabled=false \
          --set rag-stack.milvus.minio.mode=standalone \
          --set rag-stack.rag-redis.persistence.storageClass=fast-ssd \
          --set rag-stack.rag-redis.persistence.size=5Gi

    - name: Test with different namespaces
      run: |
        cd charts/ai-platform-engineering

        # Test with custom namespace
        helm template test-namespace . \
          --namespace=ai-platform-test \
          --set tags.basic=true \
          --set tags.rag-stack=false

    - name: Test with SLIM integration
      run: |
        cd charts/ai-platform-engineering

        # Test with SLIM enabled
        helm template test-slim . \
          --set global.slim.enabled=true \
          --set global.slim.endpoint=http://slim-service:46357 \
          --set global.slim.transport=slim \
          --set tags.basic=true \
          --set tags.rag-stack=false

    - name: Test with different agent configurations
      run: |
        cd charts/ai-platform-engineering

        # Test with specific agents enabled
        helm template test-agents . \
          --set tags.complete=true \
          --set tags.rag-stack=false \
          --set agent-argocd.enabled=true \
          --set agent-github.enabled=true \
          --set agent-slack.enabled=true \
          --set agent-jira.enabled=true

    - name: Validate chart packages
      run: |
        # Package rag-stack
        cd charts/rag-stack
        helm package .
        helm lint rag-stack-*.tgz
        cd ../..

        # Package ai-platform-engineering
        cd charts/ai-platform-engineering
        helm package .
        helm lint ai-platform-engineering-*.tgz

    - name: Run Helm chart tests
      run: |
        # Test rag-stack chart tests if they exist
        if helm test --help > /dev/null 2>&1; then
          echo "Helm test command available"
          # Note: helm test requires a running cluster, so we just verify the test manifests render
          cd charts/rag-stack
          helm template test-rag . --show-only templates/tests/*.yaml 2>/dev/null || echo "No test templates in rag-stack"
          cd ../..

          cd charts/ai-platform-engineering
          helm template test-ai . --show-only templates/tests/*.yaml 2>/dev/null || echo "Rendering test templates"
        fi

    - name: Clean up
      if: always()
      run: |
        rm -f charts/rag-stack/*.tgz
        rm -f charts/ai-platform-engineering/*.tgz
        rm -rf charts/rag-stack/charts/*.tgz
        rm -rf charts/ai-platform-engineering/charts/*.tgz

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: helm-test-results-${{ matrix.helm-version }}
        path: |
          charts/**/*.tgz
        retention-days: 7
        if-no-files-found: ignore
