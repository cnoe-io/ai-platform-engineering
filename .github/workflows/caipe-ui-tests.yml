name: "[CI] CAIPE UI Tests"
description: "Run CAIPE UI Jest tests on pull requests"

on:
  pull_request:
    paths:
      - 'ui/**'
      - '!ui/README.md'
      - '!ui/**/*.md'
  push:
    branches:
      - main
    paths:
      - 'ui/**'
      - '!ui/README.md'
      - '!ui/**/*.md'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ğŸ”’ Harden runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        working-directory: ui
        run: npm ci

      - name: Run Jest tests
        id: jest
        working-directory: ui
        continue-on-error: true
        run: npm test -- --coverage --coverageReporters=text --coverageReporters=json-summary

      - name: Set test results
        id: test-results
        run: |
          if [ "${{ steps.jest.outcome }}" == "success" ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "color=brightgreen" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "color=red" >> $GITHUB_OUTPUT
          fi

      - name: Extract coverage data
        id: coverage
        working-directory: ui
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            node -e "
              const coverage = require('./coverage/coverage-summary.json');
              const total = coverage.total;

              // Calculate overall percentage
              const overall = Math.round(
                (total.lines.pct + total.statements.pct + total.functions.pct + total.branches.pct) / 4
              );

              // Extract individual metrics
              const lines = total.lines.pct.toFixed(2);
              const statements = total.statements.pct.toFixed(2);
              const functions = total.functions.pct.toFixed(2);
              const branches = total.branches.pct.toFixed(2);

              const linesCovered = total.lines.covered;
              const linesTotal = total.lines.total;
              const stmtsCovered = total.statements.covered;
              const stmtsTotal = total.statements.total;
              const funcsCovered = total.functions.covered;
              const funcsTotal = total.functions.total;
              const branchesCovered = total.branches.covered;
              const branchesTotal = total.branches.total;

              console.log('percentage=' + overall);
              console.log('lines=' + lines);
              console.log('statements=' + statements);
              console.log('functions=' + functions);
              console.log('branches=' + branches);
              console.log('linesCovered=' + linesCovered);
              console.log('linesTotal=' + linesTotal);
              console.log('stmtsCovered=' + stmtsCovered);
              console.log('stmtsTotal=' + stmtsTotal);
              console.log('funcsCovered=' + funcsCovered);
              console.log('funcsTotal=' + funcsTotal);
              console.log('branchesCovered=' + branchesCovered);
              console.log('branchesTotal=' + branchesTotal);

              // Find files with lowest coverage
              const files = Object.entries(coverage)
                .filter(([path]) => path !== 'total')
                .map(([path, data]) => ({
                  path: path.replace(/^.*\/ui\//, ''),
                  coverage: Math.round(
                    (data.lines.pct + data.statements.pct + data.functions.pct + data.branches.pct) / 4
                  )
                }))
                .sort((a, b) => a.coverage - b.coverage)
                .slice(0, 10);

              console.log('lowCoverageFiles=' + JSON.stringify(files));
            " >> $GITHUB_OUTPUT
            echo "âœ… Coverage extracted successfully"
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ No coverage data found"
          fi

      - name: Comment test results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testStatus = '${{ steps.test-results.outputs.status }}';
            const testEmoji = '${{ steps.test-results.outputs.emoji }}';
            const percentage = '${{ steps.coverage.outputs.percentage }}' || '0';
            const lines = '${{ steps.coverage.outputs.lines }}' || '0';
            const statements = '${{ steps.coverage.outputs.statements }}' || '0';
            const functions = '${{ steps.coverage.outputs.functions }}' || '0';
            const branches = '${{ steps.coverage.outputs.branches }}' || '0';
            const linesCovered = '${{ steps.coverage.outputs.linesCovered }}' || '0';
            const linesTotal = '${{ steps.coverage.outputs.linesTotal }}' || '0';
            const stmtsCovered = '${{ steps.coverage.outputs.stmtsCovered }}' || '0';
            const stmtsTotal = '${{ steps.coverage.outputs.stmtsTotal }}' || '0';
            const funcsCovered = '${{ steps.coverage.outputs.funcsCovered }}' || '0';
            const funcsTotal = '${{ steps.coverage.outputs.funcsTotal }}' || '0';
            const branchesCovered = '${{ steps.coverage.outputs.branchesCovered }}' || '0';
            const branchesTotal = '${{ steps.coverage.outputs.branchesTotal }}' || '0';

            // Test status section
            const testStatusText = testStatus === 'passed'
              ? 'âœ… **All tests passed**'
              : 'âŒ **Tests failed** - Please review the logs';

            // Create coverage badge color
            let badgeColor = 'red';
            let statusEmoji = 'ğŸ”´';
            if (percentage >= 80) { badgeColor = 'brightgreen'; statusEmoji = 'ğŸŸ¢'; }
            else if (percentage >= 60) { badgeColor = 'yellow'; statusEmoji = 'ğŸŸ¡'; }
            else if (percentage >= 40) { badgeColor = 'orange'; statusEmoji = 'ğŸŸ '; }

            // Create metric badges
            const getMetricBadge = (pct, name) => {
              let color = 'red';
              if (pct >= 80) color = 'brightgreen';
              else if (pct >= 60) color = 'yellow';
              else if (pct >= 40) color = 'orange';
              return '![' + name + '](https://img.shields.io/badge/' + name + '-' + pct + '%25-' + color + ')';
            };

            const comment = `## ğŸ§ª CAIPE UI Test Results

            ${testStatusText}

            ### ${statusEmoji} Overall Coverage: ${percentage}%

            ![Coverage](https://img.shields.io/badge/overall-${percentage}%25-${badgeColor})
            ${getMetricBadge(lines, 'lines')}
            ${getMetricBadge(statements, 'statements')}
            ${getMetricBadge(functions, 'functions')}
            ${getMetricBadge(branches, 'branches')}

            ### ğŸ“Š Detailed Coverage

            | Metric | Covered | Total | Percentage |
            |--------|---------|-------|------------|
            | **Lines** | ${linesCovered} | ${linesTotal} | ${lines}% |
            | **Statements** | ${stmtsCovered} | ${stmtsTotal} | ${statements}% |
            | **Functions** | ${funcsCovered} | ${funcsTotal} | ${functions}% |
            | **Branches** | ${branchesCovered} | ${branchesTotal} | ${branches}% |

            ### âœ… Test Suites

            - âœ… auth-guard.test.tsx - Route protection & authorization
            - âœ… token-expiry-guard.test.tsx - Token expiry handling
            - âœ… a2a-sdk-client.test.ts - A2A streaming SDK
            - âœ… auth-utils.test.ts - Authentication utilities (100% coverage)
            - âœ… auth-config.test.ts - OIDC configuration

            <details>
            <summary>ğŸ“ˆ Coverage Thresholds</summary>

            | Threshold | Target | Current | Status |
            |-----------|--------|---------|--------|
            | Minimum | 40% | ${percentage}% | ${percentage >= 40 ? 'âœ… Pass' : 'âŒ Fail'} |
            | Good | 60% | ${percentage}% | ${percentage >= 60 ? 'âœ… Pass' : 'âš ï¸ Below target'} |
            | Excellent | 80% | ${percentage}% | ${percentage >= 80 ? 'âœ… Pass' : 'âš ï¸ Below target'} |

            </details>

            <details>
            <summary>âš ï¸ Areas Needing Tests</summary>

            **High Priority:**
            - hooks/use-a2a-streaming.ts - Core streaming functionality
            - store/chat-store.ts - Chat state management
            - store/agent-config-store.ts - Agent configuration
            - lib/api-client.ts - API communication
            - lib/storage-mode.ts - MongoDB/localStorage switching

            **Medium Priority:**
            - components/chat/ChatPanel.tsx - Main chat interface
            - components/agent-builder/* - Agent builder UI
            - lib/mongodb.ts - MongoDB integration

            </details>

            ---

            ğŸ’¡ **Run locally:** make caipe-ui-tests
            ğŸ“¦ **Full report:** Check workflow artifacts`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('ğŸ§ª CAIPE UI Test Results')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ui/coverage/
          retention-days: 7

      - name: Fail if tests failed
        if: steps.jest.outcome == 'failure'
        run: |
          echo "âŒ Tests failed. Please review the errors above."
          exit 1

  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: ğŸ”’ Harden runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        working-directory: ui
        run: npm ci

      - name: Run TypeScript type checking
        working-directory: ui
        continue-on-error: true
        run: npx tsc --noEmit

      - name: Run ESLint
        working-directory: ui
        continue-on-error: true
        run: npm run lint
