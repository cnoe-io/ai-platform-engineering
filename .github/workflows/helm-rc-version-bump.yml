name: "[CI][Helm] Auto-bump Chart Versions & Pre-release"
description: "Automatically bump chart versions and publish pre-release charts"

on:
  pull_request:
    paths:
      - 'charts/**'
    types: [opened, synchronize]

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  auto-bump-and-prerelease:
    name: Auto-bump & Pre-release Charts
    runs-on: ubuntu-latest
    # Skip entirely on bot commits (avoid infinite loop, versions already bumped)
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: ğŸ·ï¸ Get latest release version
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Fetching latest release version..."

          # Get the latest release tag using GitHub CLI
          LATEST_RELEASE=$(gh release view --json tagName -q '.tagName' 2>/dev/null || echo "")

          if [[ -z "$LATEST_RELEASE" ]]; then
            # Fallback: try to get from git tags
            LATEST_RELEASE=$(git tag --sort=-v:refname | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | head -1 || echo "")
          fi

          if [[ -z "$LATEST_RELEASE" ]]; then
            echo "âŒ ERROR: Could not determine latest release version"
            echo "Please ensure there is at least one release or semver tag in the repository"
            exit 1
          fi

          # Strip 'v' prefix if present
          RELEASE_VERSION="${LATEST_RELEASE#v}"

          echo "âœ… Latest release version: $RELEASE_VERSION"
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: âœ… Validate chart versions against release
        id: validate
        run: |
          RELEASE_VERSION="${{ steps.release.outputs.release_version }}"

          echo "ğŸ” Validating all chart versions against release version: $RELEASE_VERSION"
          echo ""

          # Valid patterns:
          # 1. Exact match: <release_version> (e.g., 0.2.8)
          # 2. RC pattern: <release_version>-rc.helm.<number> (e.g., 0.2.8-rc.helm.1)
          VALID_PATTERN="^${RELEASE_VERSION}(-rc\.helm\.[0-9]+)?$"

          echo "ğŸ“‹ Valid version pattern: $VALID_PATTERN"
          echo ""

          VALIDATION_FAILED=false
          FAILED_CHARTS=""

          for CHART_FILE in $(find charts -name "Chart.yaml" -type f); do
            CHART_DIR=$(dirname "$CHART_FILE")
            CHART_NAME=$(yq '.name' "$CHART_FILE")
            CHART_VERSION=$(yq '.version' "$CHART_FILE" | tr -d '"')
            APP_VERSION=$(yq '.appVersion // ""' "$CHART_FILE" | tr -d '"')

            echo "ğŸ“¦ Checking $CHART_NAME ($CHART_DIR)"
            echo "   version: $CHART_VERSION"
            echo "   appVersion: $APP_VERSION"

            # Validate chart version
            if [[ ! "$CHART_VERSION" =~ $VALID_PATTERN ]]; then
              echo "   âŒ ERROR: Chart version '$CHART_VERSION' does not match release pattern"
              echo "      Expected: '$RELEASE_VERSION' or '$RELEASE_VERSION-rc.helm.<number>'"
              VALIDATION_FAILED=true
              FAILED_CHARTS="$FAILED_CHARTS $CHART_NAME(version:$CHART_VERSION)"
            else
              echo "   âœ… Chart version is valid"
            fi

            # Validate appVersion if it exists and is not empty
            if [[ -n "$APP_VERSION" && "$APP_VERSION" != "null" ]]; then
              if [[ ! "$APP_VERSION" =~ $VALID_PATTERN ]]; then
                echo "   âŒ ERROR: appVersion '$APP_VERSION' does not match release pattern"
                echo "      Expected: '$RELEASE_VERSION' or '$RELEASE_VERSION-rc.helm.<number>'"
                VALIDATION_FAILED=true
                FAILED_CHARTS="$FAILED_CHARTS $CHART_NAME(appVersion:$APP_VERSION)"
              else
                echo "   âœ… appVersion is valid"
              fi
            fi

            echo ""
          done

          if [[ "$VALIDATION_FAILED" == "true" ]]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ VERSION VALIDATION FAILED"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The following charts have invalid versions:"
            echo "$FAILED_CHARTS" | tr ' ' '\n' | grep -v '^$' | sed 's/^/  - /'
            echo ""
            echo "All chart versions and appVersions must match one of:"
            echo "  - Exact release version: $RELEASE_VERSION"
            echo "  - RC version pattern: $RELEASE_VERSION-rc.helm.<number>"
            echo ""
            echo "Please update the chart versions to match the latest release."
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi

          echo "âœ… All chart versions are valid against release version $RELEASE_VERSION"

      - name: ğŸ” Detect changed charts
        id: detect
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"

          echo "ğŸ” Detecting changed files compared to $BASE_BRANCH..."
          CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD | grep "^charts/" || true)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "â„¹ï¸  No chart files changed"
            echo "changed_charts=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸ“‹ Changed files:"
          echo "$CHANGED_FILES" | sed 's/^/  - /'

          # Extract unique chart directories (containing Chart.yaml)
          CHANGED_CHARTS=""
          for FILE in $CHANGED_FILES; do
            # Find the Chart.yaml for this file
            DIR=$(dirname "$FILE")
            while [[ "$DIR" != "." && "$DIR" != "charts" ]]; do
              if [[ -f "$DIR/Chart.yaml" ]]; then
                CHART_NAME=$(yq '.name' "$DIR/Chart.yaml")
                if [[ ! "$CHANGED_CHARTS" =~ "$DIR" ]]; then
                  CHANGED_CHARTS="$CHANGED_CHARTS $DIR"
                fi
                break
              fi
              DIR=$(dirname "$DIR")
            done
          done

          CHANGED_CHARTS=$(echo "$CHANGED_CHARTS" | xargs)  # trim whitespace
          echo ""
          echo "ğŸ“¦ Changed charts:"
          for CHART_DIR in $CHANGED_CHARTS; do
            CHART_NAME=$(yq '.name' "$CHART_DIR/Chart.yaml")
            echo "  - $CHART_NAME ($CHART_DIR)"
          done

          echo "changed_charts=$CHANGED_CHARTS" >> $GITHUB_OUTPUT

      - name: ğŸ” Find parent charts that need bumping (cascading up)
        id: parents
        if: steps.detect.outputs.changed_charts != ''
        run: |
          CHANGED_CHARTS="${{ steps.detect.outputs.changed_charts }}"

          # Start with changed charts as the initial set to find parents for
          CHARTS_TO_CHECK="$CHANGED_CHARTS"
          ALL_PARENT_CHARTS=""

          echo "ğŸ” Finding parent charts (cascading up the dependency tree)..."

          # Keep finding parents until no new parents are found
          ITERATION=1
          while [[ -n "$CHARTS_TO_CHECK" ]]; do
            echo ""
            echo "  Iteration $ITERATION: checking parents for $(echo $CHARTS_TO_CHECK | wc -w) chart(s)"

            # Get names of charts to check
            CHART_NAMES_TO_CHECK=""
            for CHART_DIR in $CHARTS_TO_CHECK; do
              NAME=$(yq '.name' "$CHART_DIR/Chart.yaml")
              CHART_NAMES_TO_CHECK="$CHART_NAMES_TO_CHECK $NAME"
            done
            CHART_NAMES_TO_CHECK=$(echo "$CHART_NAMES_TO_CHECK" | xargs)

            # Find parent charts for this iteration
            NEW_PARENTS=""
            for CHART_FILE in $(find charts -name "Chart.yaml" -type f); do
              CHART_DIR=$(dirname "$CHART_FILE")

              # Skip if already in changed charts or already found as parent
              if [[ "$CHANGED_CHARTS $ALL_PARENT_CHARTS" =~ "$CHART_DIR" ]]; then
                continue
              fi

              # Check if this chart depends on any chart we're checking
              if yq -e '.dependencies' "$CHART_FILE" > /dev/null 2>&1; then
                for CHECK_NAME in $CHART_NAMES_TO_CHECK; do
                  # Check if dependency exists (local: no repo or file:// repo)
                  HAS_DEP=$(yq ".dependencies[] | select(.name == \"$CHECK_NAME\") | select(.repository == null or (.repository | test(\"^file://\")))" "$CHART_FILE" 2>/dev/null)
                  if [[ -n "$HAS_DEP" ]]; then
                    if [[ ! "$NEW_PARENTS" =~ "$CHART_DIR" ]]; then
                      PARENT_NAME=$(yq '.name' "$CHART_FILE")
                      NEW_PARENTS="$NEW_PARENTS $CHART_DIR"
                      echo "    ğŸ“¦ $PARENT_NAME depends on $CHECK_NAME"
                    fi
                    break
                  fi
                done
              fi
            done

            NEW_PARENTS=$(echo "$NEW_PARENTS" | xargs)

            if [[ -z "$NEW_PARENTS" ]]; then
              echo "  No more parents found"
              break
            fi

            # Add new parents to the full list
            ALL_PARENT_CHARTS="$ALL_PARENT_CHARTS $NEW_PARENTS"

            # Next iteration: check for parents of the parents we just found
            CHARTS_TO_CHECK="$NEW_PARENTS"
            ITERATION=$((ITERATION + 1))

            # Safety limit to prevent infinite loops
            if [[ $ITERATION -gt 10 ]]; then
              echo "  âš ï¸  Reached iteration limit, stopping"
              break
            fi
          done

          ALL_PARENT_CHARTS=$(echo "$ALL_PARENT_CHARTS" | xargs)
          echo ""
          echo "ğŸ“‹ All parent charts needing bump: $ALL_PARENT_CHARTS"
          echo "parent_charts=$ALL_PARENT_CHARTS" >> $GITHUB_OUTPUT

          # Combine all charts that need version check
          ALL_CHARTS="$CHANGED_CHARTS $ALL_PARENT_CHARTS"
          ALL_CHARTS=$(echo "$ALL_CHARTS" | xargs)
          echo "all_charts=$ALL_CHARTS" >> $GITHUB_OUTPUT

      - name: ğŸ” Check which charts need version bump
        id: check
        if: steps.detect.outputs.changed_charts != ''
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          ALL_CHARTS="${{ steps.parents.outputs.all_charts }}"

          echo "ğŸ” Checking which Chart.yaml files need version bump..."
          echo "ğŸ“‹ Base branch: origin/$BASE_BRANCH"
          echo ""

          # Get list of ALL Chart.yaml files that have been modified in this PR (compared to base branch)
          MODIFIED_CHART_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD | grep 'Chart\.yaml$' || true)

          echo "ğŸ“‹ Chart.yaml files already modified in this PR:"
          if [[ -n "$MODIFIED_CHART_FILES" ]]; then
            echo "$MODIFIED_CHART_FILES" | sed 's/^/  - /'
          else
            echo "  (none)"
          fi
          echo ""

          CHARTS_TO_BUMP=""
          for CHART_DIR in $ALL_CHARTS; do
            CHART_FILE="$CHART_DIR/Chart.yaml"
            CHART_NAME=$(yq '.name' "$CHART_FILE")

            echo "  ğŸ“¦ $CHART_NAME ($CHART_FILE)"

            # Check if this Chart.yaml is in the list of files modified in this PR
            if echo "$MODIFIED_CHART_FILES" | grep -qF "$CHART_FILE"; then
              # Chart.yaml already modified in this PR - don't bump again
              echo "    âœ… Chart.yaml already modified in this PR â†’ skip"
            else
              # Chart.yaml not modified in this PR - needs bump
              echo "    âŒ Chart.yaml not modified in this PR â†’ needs bump"
              CHARTS_TO_BUMP="$CHARTS_TO_BUMP $CHART_DIR"
            fi
          done

          CHARTS_TO_BUMP=$(echo "$CHARTS_TO_BUMP" | xargs)
          echo ""
          echo "charts_to_bump=$CHARTS_TO_BUMP" >> $GITHUB_OUTPUT

          if [[ -z "$CHARTS_TO_BUMP" ]]; then
            echo "âœ… All Chart.yaml files already modified in this PR - nothing to bump"
          else
            echo "ğŸ“ Charts needing version bump: $CHARTS_TO_BUMP"
          fi

      - name: ğŸ“ Bump chart versions
        id: bump
        if: steps.check.outputs.charts_to_bump != ''
        run: |
          CHARTS_TO_BUMP="${{ steps.check.outputs.charts_to_bump }}"
          RELEASE_VERSION="${{ steps.release.outputs.release_version }}"

          echo "ğŸ”„ Bumping chart versions..."
          echo "ğŸ“‹ Base release version: $RELEASE_VERSION"

          BUMPED_CHARTS=""
          for CHART_DIR in $CHARTS_TO_BUMP; do
            CHART_FILE="$CHART_DIR/Chart.yaml"
            CHART_NAME=$(yq '.name' "$CHART_FILE")
            # Normalize version: strip quotes and whitespace
            CURRENT_VERSION=$(yq '.version' "$CHART_FILE" | tr -d '"' | tr -d "'" | xargs)

            # Determine new version: increment rc number by 1
            if [[ "$CURRENT_VERSION" =~ -rc\.helm\.([0-9]+)$ ]]; then
              # Already has rc.helm suffix, increment it
              CURRENT_RC="${BASH_REMATCH[1]}"
              NEW_RC=$((CURRENT_RC + 1))
              NEW_VERSION="${RELEASE_VERSION}-rc.helm.${NEW_RC}"
            else
              # No rc.helm suffix, start with 1
              NEW_VERSION="${RELEASE_VERSION}-rc.helm.1"
            fi

            echo "  ğŸ“¦ $CHART_NAME: $CURRENT_VERSION â†’ $NEW_VERSION"

            # Update the version
            yq -i ".version = \"$NEW_VERSION\"" "$CHART_FILE"

            BUMPED_CHARTS="$BUMPED_CHARTS $CHART_NAME"
          done

          BUMPED_CHARTS=$(echo "$BUMPED_CHARTS" | xargs)
          echo ""
          echo "bumped_charts=$BUMPED_CHARTS" >> $GITHUB_OUTPUT

      - name: ğŸ”„ Update parent dependency versions
        if: steps.bump.outputs.bumped_charts != ''
        run: |
          CHARTS_TO_BUMP="${{ steps.check.outputs.charts_to_bump }}"

          echo "ğŸ”„ Updating dependency version references in parent charts..."

          # Build a map of chart name -> new version
          declare -A VERSION_MAP
          for CHART_DIR in $CHARTS_TO_BUMP; do
            CHART_NAME=$(yq '.name' "$CHART_DIR/Chart.yaml")
            NEW_VERSION=$(yq '.version' "$CHART_DIR/Chart.yaml")
            VERSION_MAP[$CHART_NAME]=$NEW_VERSION
            echo "  $CHART_NAME = $NEW_VERSION"
          done

          # Update dependency references in all parent charts
          for CHART_FILE in $(find charts -name "Chart.yaml" -type f); do
            if yq -e '.dependencies' "$CHART_FILE" > /dev/null 2>&1; then
              for CHART_NAME in "${!VERSION_MAP[@]}"; do
                NEW_VERSION="${VERSION_MAP[$CHART_NAME]}"

                # Update local dependencies (no repo or file:// repo)
                yq -i "(.dependencies[] | select(.name == \"$CHART_NAME\" and .repository == null)).version = \"$NEW_VERSION\"" "$CHART_FILE" 2>/dev/null || true
                yq -i "(.dependencies[] | select(.name == \"$CHART_NAME\" and .repository != null and (.repository | test(\"^file://\")))).version = \"$NEW_VERSION\"" "$CHART_FILE" 2>/dev/null || true
              done
            fi
          done

          echo "âœ… Updated dependency version references"

      - name: ğŸ“¤ Commit and push version bumps
        id: commit
        if: steps.bump.outputs.bumped_charts != ''
        run: |
          BUMPED_CHARTS="${{ steps.bump.outputs.bumped_charts }}"

          # Check if there are changes to commit
          if git diff --quiet; then
            echo "â„¹ï¸  No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage and commit
          find charts -name "Chart.yaml" -type f -exec git add {} +
          git commit -m "chore: bump chart versions for $BUMPED_CHARTS"

          # Push to PR branch
          git push

          echo "âœ… Committed and pushed chart version bumps"
          echo ""
          echo "ğŸ“‹ Bumped charts: $BUMPED_CHARTS"
          echo "committed=true" >> $GITHUB_OUTPUT

      # ============================================================
      # PRE-RELEASE SECTION
      # Runs after version bump (if any) to publish pre-release charts
      # ============================================================

      - name: ğŸ” Check if pre-release should run
        id: should-prerelease
        run: |
          HEAD_REF="${{ github.head_ref }}"

          echo "ğŸ” Checking pre-release conditions..."
          echo "  Branch: $HEAD_REF"

          SHOULD_RUN=false

          # Check for prebuild/ branch from same repo
          if [[ "$HEAD_REF" == prebuild/* ]]; then
            echo "âœ… Matched: prebuild/ branch"
            SHOULD_RUN=true
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT

          if [[ "$SHOULD_RUN" != "true" ]]; then
            echo "â„¹ï¸ Not a prebuild/ branch - checking for helm-prerelease label..."
          fi

      - name: ğŸ” Check for helm-prerelease label
        id: check-label
        if: steps.should-prerelease.outputs.should_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const hasLabel = pr.labels.some(l => l.name === 'helm-prerelease');
            console.log(`PR has helm-prerelease label: ${hasLabel}`);
            core.setOutput('has_label', hasLabel.toString());

      - name: ğŸ” Determine if pre-release should proceed
        id: prerelease-decision
        run: |
          if [[ "${{ steps.should-prerelease.outputs.should_run }}" == "true" ]]; then
            echo "âœ… Pre-release will run (prebuild/ branch)"
            echo "proceed=true" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.check-label.outputs.has_label }}" == "true" ]]; then
            echo "âœ… Pre-release will run (helm-prerelease label)"
            echo "proceed=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Skipping pre-release - no matching conditions"
            echo "  To enable pre-release: use 'prebuild/' branch prefix OR add 'helm-prerelease' label"
            echo "proceed=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¥ Re-checkout latest commit (after version bump)
        if: steps.prerelease-decision.outputs.proceed == 'true' && steps.commit.outputs.committed == 'true'
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: âš™ï¸ Set up Helm
        if: steps.prerelease-decision.outputs.proceed == 'true'
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: ğŸ” Login to GHCR
        if: steps.prerelease-decision.outputs.proceed == 'true'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: ğŸ” Detect Charts for Pre-release
        if: steps.prerelease-decision.outputs.proceed == 'true'
        id: prerelease-detect
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"

          CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check which charts changed (excluding Chart.lock only changes)
          RAG_STACK_CHANGED=false
          AI_PLATFORM_CHANGED=false

          # Check rag-stack changes
          if echo "$CHANGED_FILES" | grep -q "^charts/rag-stack/"; then
            if echo "$CHANGED_FILES" | grep "^charts/rag-stack/" | grep -qv "Chart.lock$"; then
              RAG_STACK_CHANGED=true
              echo "âœ… rag-stack chart has substantive changes"
            else
              echo "â„¹ï¸  rag-stack only has Chart.lock changes, skipping pre-release"
            fi
          fi

          # Check ai-platform-engineering changes
          if echo "$CHANGED_FILES" | grep -q "^charts/ai-platform-engineering/"; then
            if echo "$CHANGED_FILES" | grep "^charts/ai-platform-engineering/" | grep -qv "Chart.lock$"; then
              AI_PLATFORM_CHANGED=true
              echo "âœ… ai-platform-engineering chart has substantive changes"
            else
              echo "â„¹ï¸  ai-platform-engineering only has Chart.lock changes, skipping pre-release"
            fi
          fi

          echo "rag-stack-changed=$RAG_STACK_CHANGED" >> $GITHUB_OUTPUT
          echo "ai-platform-changed=$AI_PLATFORM_CHANGED" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Generate Pre-release Versions
        if: steps.prerelease-decision.outputs.proceed == 'true'
        id: prerelease-version
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"

          # Get branch name and remove 'prebuild/' prefix if present
          BRANCH_NAME="${{ github.head_ref }}"
          CLEAN_BRANCH=$(echo "${BRANCH_NAME#prebuild/}" | tr '/' '-' | tr '_' '-' | tr '[:upper:]' '[:lower:]')

          # Get commit count for this PR
          COMMIT_COUNT=$(git rev-list --count origin/$BASE_BRANCH..HEAD)

          echo "clean-branch=$CLEAN_BRANCH" >> $GITHUB_OUTPUT
          echo "commit-count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

          # Generate version for rag-stack if changed
          if [[ "${{ steps.prerelease-detect.outputs.rag-stack-changed }}" == "true" ]]; then
            if git show origin/$BASE_BRANCH:charts/rag-stack/Chart.yaml &>/dev/null; then
              RAG_STACK_BASE=$(git show origin/$BASE_BRANCH:charts/rag-stack/Chart.yaml | grep "^version:" | awk '{print $2}')
              IFS='.' read -r MAJOR MINOR PATCH <<< "$RAG_STACK_BASE"
              NEXT_PATCH=$((PATCH + 1))
              RAG_STACK_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-${CLEAN_BRANCH}-${COMMIT_COUNT}"
            else
              RAG_STACK_VERSION=$(grep "^version:" charts/rag-stack/Chart.yaml | awk '{print $2}')
              RAG_STACK_VERSION="${RAG_STACK_VERSION}-${CLEAN_BRANCH}-${COMMIT_COUNT}"
            fi
            echo "rag-stack version: $RAG_STACK_VERSION"
            echo "rag-stack-version=$RAG_STACK_VERSION" >> $GITHUB_OUTPUT
          fi

          # Generate version for ai-platform-engineering if changed
          if [[ "${{ steps.prerelease-detect.outputs.ai-platform-changed }}" == "true" ]]; then
            if git show origin/$BASE_BRANCH:charts/ai-platform-engineering/Chart.yaml &>/dev/null; then
              AI_PLATFORM_BASE=$(git show origin/$BASE_BRANCH:charts/ai-platform-engineering/Chart.yaml | grep "^version:" | awk '{print $2}')
              IFS='.' read -r MAJOR MINOR PATCH <<< "$AI_PLATFORM_BASE"
              NEXT_PATCH=$((PATCH + 1))
              AI_PLATFORM_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-${CLEAN_BRANCH}-${COMMIT_COUNT}"
            else
              AI_PLATFORM_VERSION=$(grep "^version:" charts/ai-platform-engineering/Chart.yaml | awk '{print $2}')
              AI_PLATFORM_VERSION="${AI_PLATFORM_VERSION}-${CLEAN_BRANCH}-${COMMIT_COUNT}"
            fi
            echo "ai-platform-engineering version: $AI_PLATFORM_VERSION"
            echo "ai-platform-version=$AI_PLATFORM_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ Package rag-stack Chart
        if: steps.prerelease-decision.outputs.proceed == 'true' && steps.prerelease-detect.outputs.rag-stack-changed == 'true'
        run: |
          echo "ğŸ“¦ Packaging rag-stack..."

          mkdir -p ./packaged-charts

          # Update Chart.yaml with pre-release version
          sed -i "s/^version:.*/version: ${{ steps.prerelease-version.outputs.rag-stack-version }}/" charts/rag-stack/Chart.yaml

          # Update dependencies and package
          helm dependency update charts/rag-stack/
          helm package charts/rag-stack/ --destination ./packaged-charts/

          echo "âœ… rag-stack packaged successfully"

      - name: ğŸ“¦ Package ai-platform-engineering Chart
        if: steps.prerelease-decision.outputs.proceed == 'true' && steps.prerelease-detect.outputs.ai-platform-changed == 'true'
        run: |
          echo "ğŸ“¦ Packaging ai-platform-engineering..."

          mkdir -p ./packaged-charts

          # Update Chart.yaml with pre-release version
          sed -i "s/^version:.*/version: ${{ steps.prerelease-version.outputs.ai-platform-version }}/" charts/ai-platform-engineering/Chart.yaml

          # If rag-stack was also changed, update its dependency version
          if [[ "${{ steps.prerelease-detect.outputs.rag-stack-changed }}" == "true" ]]; then
            echo "ğŸ“ Updating rag-stack dependency version to ${{ steps.prerelease-version.outputs.rag-stack-version }}"
            sed -i "/name: rag-stack/,/repository:/ s/version:.*/version: ${{ steps.prerelease-version.outputs.rag-stack-version }}/" charts/ai-platform-engineering/Chart.yaml
          fi

          # CRITICAL: Always update rag-stack dependencies first
          echo "Updating rag-stack dependencies..."
          helm dependency update charts/rag-stack/

          echo "Updating ai-platform-engineering dependencies..."
          helm dependency update charts/ai-platform-engineering/

          helm package charts/ai-platform-engineering/ --destination ./packaged-charts/

          # Verify dependencies are packaged correctly
          echo "ğŸ” Verifying rag-stack dependencies..."
          if tar -tzf charts/ai-platform-engineering/charts/rag-stack-*.tgz | grep -q "^rag-stack/charts/neo4j/Chart.yaml"; then
            echo "âœ… neo4j dependency verified"
          else
            echo "âŒ ERROR: neo4j missing from rag-stack package"
            exit 1
          fi

          if tar -tzf charts/ai-platform-engineering/charts/rag-stack-*.tgz | grep -q "^rag-stack/charts/milvus/Chart.yaml"; then
            echo "âœ… milvus dependency verified"
          else
            echo "âŒ ERROR: milvus missing from rag-stack package"
            exit 1
          fi

          echo "âœ… ai-platform-engineering packaged successfully with all dependencies"

      - name: ğŸš€ Push Pre-release Charts to GHCR
        if: steps.prerelease-decision.outputs.proceed == 'true'
        run: |
          REGISTRY="oci://ghcr.io/${{ github.repository_owner }}/pre-release-helm-charts"

          echo "ğŸ“¦ Pushing pre-release charts to $REGISTRY"

          for CHART_FILE in ./packaged-charts/*.tgz; do
            if [ -f "$CHART_FILE" ]; then
              CHART_NAME=$(helm show chart "$CHART_FILE" | grep '^name:' | awk '{print $2}')
              CHART_VERSION=$(helm show chart "$CHART_FILE" | grep '^version:' | awk '{print $2}')

              echo "ğŸ“¦ Pushing $CHART_NAME:$CHART_VERSION"
              helm push "$CHART_FILE" "$REGISTRY"
              echo "âœ… $CHART_NAME:$CHART_VERSION published successfully!"
            fi
          done

      - name: ğŸ’¬ Comment on PR
        if: steps.prerelease-decision.outputs.proceed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const registry = `ghcr.io/${{ github.repository_owner }}/pre-release-helm-charts`;
            const ragStackChanged = '${{ steps.prerelease-detect.outputs.rag-stack-changed }}' === 'true';
            const aiPlatformChanged = '${{ steps.prerelease-detect.outputs.ai-platform-changed }}' === 'true';
            const prNumber = context.payload.pull_request.number;

            let body = `## ğŸ“¦ Pre-release Helm Charts Published\n\n`;
            body += `**Registry:** \`${registry}\`\n\n`;

            if (ragStackChanged) {
              const version = '${{ steps.prerelease-version.outputs.rag-stack-version }}';
              body += `### rag-stack\n`;
              body += `**Version:** \`${version}\`\n\n`;
              body += `\`\`\`bash\n`;
              body += `helm upgrade --install rag oci://${registry}/rag-stack --version ${version}\n`;
              body += `\`\`\`\n\n`;
            }

            if (aiPlatformChanged) {
              const version = '${{ steps.prerelease-version.outputs.ai-platform-version }}';
              body += `### ai-platform-engineering\n`;
              body += `**Version:** \`${version}\`\n\n`;
              body += `\`\`\`bash\n`;
              body += `helm upgrade --install ai-platform oci://${registry}/ai-platform-engineering --version ${version}\n`;
              body += `\`\`\`\n\n`;
            }

            body += `> **Note:** These pre-release versions will be automatically cleaned up when the PR is closed or merged.\n`;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
