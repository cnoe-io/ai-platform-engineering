name: "[CI][Helm] Publish Helm Charts to GHCR"
description: "Publish Helm charts to GitHub Container Registry"

on:
  push:
    branches:
      - main
    paths:
      - charts/**

permissions:
  contents: read
  packages: write

jobs:
  publish:
    name: Push Helm Charts to GHCR
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: üîê Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: üîç Detect Changed Charts
        id: detect
        run: |
          # Detect which charts have changes compared to previous commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files in this push:"
          echo "$CHANGED_FILES"

          # Check which charts changed
          RAG_STACK_CHANGED=false
          AI_PLATFORM_CHANGED=false

          if echo "$CHANGED_FILES" | grep -q "^charts/rag-stack/"; then
            RAG_STACK_CHANGED=true
            echo "‚úÖ rag-stack chart has changes"
          fi

          if echo "$CHANGED_FILES" | grep -q "^charts/ai-platform-engineering/"; then
            AI_PLATFORM_CHANGED=true
            echo "‚úÖ ai-platform-engineering chart has changes"
          fi

          echo "rag-stack-changed=$RAG_STACK_CHANGED" >> $GITHUB_OUTPUT
          echo "ai-platform-changed=$AI_PLATFORM_CHANGED" >> $GITHUB_OUTPUT

          # Check for substantive changes (not just Chart.lock)
          RAG_STACK_NEEDS_VERSION_BUMP=false
          AI_PLATFORM_NEEDS_VERSION_BUMP=false

          if [ "$RAG_STACK_CHANGED" = true ]; then
            if echo "$CHANGED_FILES" | grep "^charts/rag-stack/" | grep -qv "Chart.lock$"; then
              RAG_STACK_NEEDS_VERSION_BUMP=true
            fi
          fi

          if [ "$AI_PLATFORM_CHANGED" = true ]; then
            if echo "$CHANGED_FILES" | grep "^charts/ai-platform-engineering/" | grep -qv "Chart.lock$"; then
              AI_PLATFORM_NEEDS_VERSION_BUMP=true
            fi
          fi

          echo "rag-stack-needs-version-bump=$RAG_STACK_NEEDS_VERSION_BUMP" >> $GITHUB_OUTPUT
          echo "ai-platform-needs-version-bump=$AI_PLATFORM_NEEDS_VERSION_BUMP" >> $GITHUB_OUTPUT

      - name: üîç Check Version Bumps
        run: |
          # Function to validate version bump
          # Valid bumps:
          #   0.2.8 -> 0.2.9 (standard increment)
          #   0.2.8 -> 0.2.8.rc.helm.1 (adding RC to same base)
          #   0.2.8.rc.helm.1 -> 0.2.8.rc.helm.2 (RC increment)
          #   0.2.8.rc.helm.1 -> 0.2.8 (releasing from RC)
          #   0.2.8.rc.helm.1 -> 0.2.9 (new version from RC)
          validate_version_bump() {
            local OLD_VERSION="$1"
            local NEW_VERSION="$2"

            # If versions are identical, fail
            if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
              echo "‚ùå Versions are identical"
              return 1
            fi

            # Extract base version and RC suffix
            # Pattern: X.Y.Z or X.Y.Z.rc.helm.N
            OLD_BASE=$(echo "$OLD_VERSION" | sed 's/\.rc\.helm\.[0-9]*$//')
            NEW_BASE=$(echo "$NEW_VERSION" | sed 's/\.rc\.helm\.[0-9]*$//')

            OLD_RC=$(echo "$OLD_VERSION" | grep -o '\.rc\.helm\.[0-9]*$' | grep -o '[0-9]*$' || echo "")
            NEW_RC=$(echo "$NEW_VERSION" | grep -o '\.rc\.helm\.[0-9]*$' | grep -o '[0-9]*$' || echo "")

            echo "  Old: base=$OLD_BASE, rc=$OLD_RC"
            echo "  New: base=$NEW_BASE, rc=$NEW_RC"

            # Case 1: Base version changed (e.g., 0.2.8 -> 0.2.9)
            if [ "$OLD_BASE" != "$NEW_BASE" ]; then
              echo "‚úÖ Base version changed: $OLD_BASE -> $NEW_BASE"
              return 0
            fi

            # Case 2: Same base, adding RC (e.g., 0.2.8 -> 0.2.8.rc.helm.1)
            if [ -z "$OLD_RC" ] && [ -n "$NEW_RC" ]; then
              echo "‚úÖ Added RC suffix: $OLD_VERSION -> $NEW_VERSION"
              return 0
            fi

            # Case 3: Same base, incrementing RC (e.g., 0.2.8.rc.helm.1 -> 0.2.8.rc.helm.2)
            if [ -n "$OLD_RC" ] && [ -n "$NEW_RC" ]; then
              if [ "$NEW_RC" -gt "$OLD_RC" ]; then
                echo "‚úÖ RC incremented: $OLD_RC -> $NEW_RC"
                return 0
              else
                echo "‚ùå RC must increment: $OLD_RC -> $NEW_RC (expected higher number)"
                return 1
              fi
            fi

            # Case 4: Releasing from RC (e.g., 0.2.8.rc.helm.1 -> 0.2.8)
            if [ -n "$OLD_RC" ] && [ -z "$NEW_RC" ]; then
              echo "‚úÖ Released from RC: $OLD_VERSION -> $NEW_VERSION"
              return 0
            fi

            echo "‚ùå Invalid version transition"
            return 1
          }

          # Check rag-stack version bump
          if [ "${{ steps.detect.outputs.rag-stack-needs-version-bump }}" = "true" ]; then
            echo ""
            echo "Checking rag-stack version bump..."
            CURRENT_VERSION=$(grep "^version:" charts/rag-stack/Chart.yaml | awk '{print $2}')
            echo "Current version: $CURRENT_VERSION"

            if git show HEAD~1:charts/rag-stack/Chart.yaml &>/dev/null; then
              BASE_VERSION=$(git show HEAD~1:charts/rag-stack/Chart.yaml | grep "^version:" | awk '{print $2}')
              echo "Previous version: $BASE_VERSION"

              if ! validate_version_bump "$BASE_VERSION" "$CURRENT_VERSION"; then
                echo ""
                echo "‚ùå Error: rag-stack chart has changes but version was not properly bumped!"
                echo "Valid version bumps:"
                echo "  - Standard: $BASE_VERSION -> X.Y.Z (higher version)"
                echo "  - RC: $BASE_VERSION -> ${BASE_VERSION}.rc.helm.1"
                echo "  - RC increment: X.Y.Z.rc.helm.N -> X.Y.Z.rc.helm.(N+1)"
                exit 1
              fi
            else
              echo "‚ÑπÔ∏è  rag-stack is a new chart, skipping version bump check"
            fi
          fi

          # Check ai-platform-engineering version bump
          if [ "${{ steps.detect.outputs.ai-platform-needs-version-bump }}" = "true" ]; then
            echo ""
            echo "Checking ai-platform-engineering version bump..."
            CURRENT_VERSION=$(grep "^version:" charts/ai-platform-engineering/Chart.yaml | awk '{print $2}')
            echo "Current version: $CURRENT_VERSION"

            if git show HEAD~1:charts/ai-platform-engineering/Chart.yaml &>/dev/null; then
              BASE_VERSION=$(git show HEAD~1:charts/ai-platform-engineering/Chart.yaml | grep "^version:" | awk '{print $2}')
              echo "Previous version: $BASE_VERSION"

              if ! validate_version_bump "$BASE_VERSION" "$CURRENT_VERSION"; then
                echo ""
                echo "‚ùå Error: ai-platform-engineering chart has changes but version was not properly bumped!"
                echo "Valid version bumps:"
                echo "  - Standard: $BASE_VERSION -> X.Y.Z (higher version)"
                echo "  - RC: $BASE_VERSION -> ${BASE_VERSION}.rc.helm.1"
                echo "  - RC increment: X.Y.Z.rc.helm.N -> X.Y.Z.rc.helm.(N+1)"
                exit 1
              fi
            else
              echo "‚ÑπÔ∏è  ai-platform-engineering is a new chart, skipping version bump check"
            fi
          fi

          echo ""
          echo "‚úÖ All version checks passed!"

      - name: üì¶ Package rag-stack Chart
        if: steps.detect.outputs.rag-stack-changed == 'true'
        run: |
          echo "üì¶ Packaging rag-stack..."

          # Check if version changed
          CURRENT_VERSION=$(grep "^version:" charts/rag-stack/Chart.yaml | awk '{print $2}')
          echo "Current version: $CURRENT_VERSION"

          REGISTRY="oci://ghcr.io/${{ github.repository_owner }}/helm-charts"
          if helm pull $REGISTRY/rag-stack --version $CURRENT_VERSION --destination /tmp 2>/dev/null; then
            echo "‚è≠Ô∏è  rag-stack:$CURRENT_VERSION already published, skipping"
            echo "rag-stack-skip=true" >> $GITHUB_ENV
            exit 0
          fi

          echo "‚úÖ Version $CURRENT_VERSION not published yet, proceeding with package"

          mkdir -p ./packaged-charts
          helm dependency update charts/rag-stack/
          helm package charts/rag-stack/ --destination ./packaged-charts/

          echo "‚úÖ rag-stack packaged successfully"

      - name: üì¶ Package ai-platform-engineering Chart
        if: steps.detect.outputs.ai-platform-changed == 'true'
        run: |
          echo "üì¶ Packaging ai-platform-engineering..."

          mkdir -p ./packaged-charts

          # CRITICAL: Always update rag-stack dependencies first
          # ai-platform-engineering depends on rag-stack, which depends on neo4j and milvus
          # These external dependencies must be downloaded regardless of path changes
          echo "Updating rag-stack dependencies..."
          helm dependency update charts/rag-stack/

          echo "Updating ai-platform-engineering dependencies..."
          helm dependency update charts/ai-platform-engineering/

          helm package charts/ai-platform-engineering/ --destination ./packaged-charts/

          # Verify dependencies are packaged correctly
          echo "üîç Verifying rag-stack dependencies..."
          if tar -tzf charts/ai-platform-engineering/charts/rag-stack-*.tgz | grep -q "^rag-stack/charts/neo4j/Chart.yaml"; then
            echo "‚úÖ neo4j dependency verified"
          else
            echo "‚ùå ERROR: neo4j missing from rag-stack package"
            exit 1
          fi

          if tar -tzf charts/ai-platform-engineering/charts/rag-stack-*.tgz | grep -q "^rag-stack/charts/milvus/Chart.yaml"; then
            echo "‚úÖ milvus dependency verified"
          else
            echo "‚ùå ERROR: milvus missing from rag-stack package"
            exit 1
          fi

          echo "‚úÖ ai-platform-engineering packaged successfully with all dependencies"

      - name: üöÄ Push Charts to GHCR
        run: |
          REGISTRY="oci://ghcr.io/${{ github.repository_owner }}/helm-charts"

          echo "üì¶ Pushing charts to $REGISTRY"

          for CHART_FILE in ./packaged-charts/*.tgz; do
            if [ -f "$CHART_FILE" ]; then
              CHART_NAME=$(helm show chart "$CHART_FILE" | grep '^name:' | awk '{print $2}')
              CHART_VERSION=$(helm show chart "$CHART_FILE" | grep '^version:' | awk '{print $2}')

              echo ""
              echo "Processing $CHART_NAME:$CHART_VERSION"

              # Check if this version already exists
              if helm pull $REGISTRY/$CHART_NAME --version $CHART_VERSION --destination /tmp 2>/dev/null; then
                echo "‚ö†Ô∏è  $CHART_NAME:$CHART_VERSION already exists in registry, skipping push"
                echo "If you intended to update the chart, please bump the version in charts/$CHART_NAME/Chart.yaml"
              else
                echo "‚úÖ $CHART_NAME:$CHART_VERSION does not exist, proceeding with push"
                helm push "$CHART_FILE" $REGISTRY
                echo "üéâ Successfully pushed $CHART_NAME:$CHART_VERSION to $REGISTRY"
              fi
            fi
          done