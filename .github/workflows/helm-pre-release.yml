name: "[Pre-Release] Helm Chart"
description: "Publish pre-release Helm charts"

on:
  # Called directly from helm-rc-version-bump workflow
  workflow_call:
    inputs:
      pr_number:
        description: 'PR number to publish pre-release for'
        required: true
        type: number
      new_commit:
        description: 'Whether a new commit was made by version bump'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  pull-requests: write
  actions: read

jobs:
  publish-pre-release:
    name: Publish Pre-release Helm Chart
    runs-on: ubuntu-latest
    # Skip if a new commit was made (will re-run on next trigger)
    if: ${{ !inputs.new_commit }}

    steps:
      - name: ðŸ“‹ Set PR info from inputs
        id: bump-status
        run: |
          echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Processing PR #${{ inputs.pr_number }}"

      - name: ðŸ” Get PR details
        id: pr-info
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = '${{ steps.bump-status.outputs.pr_number }}';
            if (!prNumber) {
              core.setFailed('PR number not found in artifact');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });

            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('head_repo_full_name', pr.head.repo.full_name);
            core.setOutput('labels', pr.labels.map(l => l.name).join(','));

            console.log(`PR #${prNumber}: ${pr.head.ref} -> ${pr.base.ref}`);
            console.log(`Head SHA: ${pr.head.sha}`);
            console.log(`Labels: ${pr.labels.map(l => l.name).join(', ')}`);

      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.pr-info.outputs.head_sha }}
          fetch-depth: 0

      - name: ðŸ” Check if chart versions are bumped
        id: version-check
        run: |
          git fetch origin main

          echo "ðŸ” Checking if chart versions have been bumped..."

          # Check if any changed chart has unbumped version
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep "^charts/" || true)

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find unique chart directories
          CHART_DIRS=""
          for FILE in $CHANGED_FILES; do
            DIR=$(dirname "$FILE")
            while [[ "$DIR" != "." && "$DIR" != "charts" ]]; do
              if [[ -f "$DIR/Chart.yaml" ]]; then
                if [[ ! "$CHART_DIRS" =~ "$DIR" ]]; then
                  CHART_DIRS="$CHART_DIRS $DIR"
                fi
                break
              fi
              DIR=$(dirname "$DIR")
            done
          done

          # Check if any chart version is NOT bumped
          NEEDS_BUMP=false
          for CHART_DIR in $CHART_DIRS; do
            if [[ -f "$CHART_DIR/Chart.yaml" ]]; then
              CURRENT_VERSION=$(grep "^version:" "$CHART_DIR/Chart.yaml" | awk '{print $2}' | tr -d '"')
              BASE_VERSION=$(git show origin/main:$CHART_DIR/Chart.yaml 2>/dev/null | grep "^version:" | awk '{print $2}' | tr -d '"' || echo "0.0.0")

              if [[ "$CURRENT_VERSION" == "$BASE_VERSION" ]]; then
                echo "  â³ $CHART_DIR: version not bumped yet ($CURRENT_VERSION)"
                NEEDS_BUMP=true
              else
                echo "  âœ… $CHART_DIR: version bumped ($BASE_VERSION â†’ $CURRENT_VERSION)"
              fi
            fi
          done

          if [[ "$NEEDS_BUMP" == "true" ]]; then
            echo "â³ Skipping pre-release - waiting for helm-rc-version-bump to complete"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… All chart versions bumped, proceeding with pre-release"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: âš™ï¸ Set up Helm
        if: steps.version-check.outputs.skip != 'true'
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: ðŸ” Login to GHCR
        if: steps.version-check.outputs.skip != 'true'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: ðŸ” Detect Changed Charts
        if: steps.version-check.outputs.skip != 'true'
        id: detect
        run: |
          # Detect which charts have changes (excluding Chart.lock only changes)
          git fetch origin main

          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check which charts changed (excluding Chart.lock only changes)
          RAG_STACK_CHANGED=false
          AI_PLATFORM_CHANGED=false

          # Check rag-stack changes
          if echo "$CHANGED_FILES" | grep -q "^charts/rag-stack/"; then
            # Check if changes are more than just Chart.lock
            if echo "$CHANGED_FILES" | grep "^charts/rag-stack/" | grep -qv "Chart.lock$"; then
              RAG_STACK_CHANGED=true
              echo "âœ… rag-stack chart has substantive changes"
            else
              echo "â„¹ï¸  rag-stack only has Chart.lock changes, skipping pre-release"
            fi
          fi

          # Check ai-platform-engineering changes
          if echo "$CHANGED_FILES" | grep -q "^charts/ai-platform-engineering/"; then
            # Check if changes are more than just Chart.lock
            if echo "$CHANGED_FILES" | grep "^charts/ai-platform-engineering/" | grep -qv "Chart.lock$"; then
              AI_PLATFORM_CHANGED=true
              echo "âœ… ai-platform-engineering chart has substantive changes"
            else
              echo "â„¹ï¸  ai-platform-engineering only has Chart.lock changes, skipping pre-release"
            fi
          fi

          echo "rag-stack-changed=$RAG_STACK_CHANGED" >> $GITHUB_OUTPUT
          echo "ai-platform-changed=$AI_PLATFORM_CHANGED" >> $GITHUB_OUTPUT

      - name: ðŸ·ï¸ Generate Pre-release Versions
        if: steps.version-check.outputs.skip != 'true'
        id: version
        run: |
          # Get branch name and remove 'prebuild/' prefix if present
          BRANCH_NAME="${{ steps.pr-info.outputs.head_ref }}"
          CLEAN_BRANCH=$(echo "${BRANCH_NAME#prebuild/}" | tr '/' '-' | tr '_' '-' | tr '[:upper:]' '[:lower:]')

          # Get commit count for this PR
          COMMIT_COUNT=$(git rev-list --count origin/${{ steps.pr-info.outputs.base_ref }}..HEAD)

          echo "clean-branch=$CLEAN_BRANCH" >> $GITHUB_OUTPUT
          echo "commit-count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

          # Generate version for rag-stack if changed
          if [[ "${{ steps.detect.outputs.rag-stack-changed }}" == "true" ]]; then
            # Check if chart exists in main
            if git show origin/main:charts/rag-stack/Chart.yaml &>/dev/null; then
              RAG_STACK_BASE=$(git show origin/main:charts/rag-stack/Chart.yaml | grep "^version:" | awk '{print $2}')
              IFS='.' read -r MAJOR MINOR PATCH <<< "$RAG_STACK_BASE"
              NEXT_PATCH=$((PATCH + 1))
              RAG_STACK_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-${CLEAN_BRANCH}-${COMMIT_COUNT}"
            else
              echo "â„¹ï¸ rag-stack is a new chart (doesn't exist in main), using PR version"
              RAG_STACK_VERSION=$(grep "^version:" charts/rag-stack/Chart.yaml | awk '{print $2}')
              RAG_STACK_VERSION="${RAG_STACK_VERSION}-${CLEAN_BRANCH}-${COMMIT_COUNT}"
            fi
            echo "rag-stack version: $RAG_STACK_VERSION"
            echo "rag-stack-version=$RAG_STACK_VERSION" >> $GITHUB_OUTPUT
          fi

          # Generate version for ai-platform-engineering if changed
          if [[ "${{ steps.detect.outputs.ai-platform-changed }}" == "true" ]]; then
            # Check if chart exists in main
            if git show origin/main:charts/ai-platform-engineering/Chart.yaml &>/dev/null; then
              AI_PLATFORM_BASE=$(git show origin/main:charts/ai-platform-engineering/Chart.yaml | grep "^version:" | awk '{print $2}')
              IFS='.' read -r MAJOR MINOR PATCH <<< "$AI_PLATFORM_BASE"
              NEXT_PATCH=$((PATCH + 1))
              AI_PLATFORM_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-${CLEAN_BRANCH}-${COMMIT_COUNT}"
            else
              echo "â„¹ï¸ ai-platform-engineering is a new chart (doesn't exist in main), using PR version"
              AI_PLATFORM_VERSION=$(grep "^version:" charts/ai-platform-engineering/Chart.yaml | awk '{print $2}')
              AI_PLATFORM_VERSION="${AI_PLATFORM_VERSION}-${CLEAN_BRANCH}-${COMMIT_COUNT}"
            fi
            echo "ai-platform-engineering version: $AI_PLATFORM_VERSION"
            echo "ai-platform-version=$AI_PLATFORM_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¦ Package rag-stack Chart
        if: steps.version-check.outputs.skip != 'true' && steps.detect.outputs.rag-stack-changed == 'true'
        run: |
          echo "ðŸ“¦ Packaging rag-stack..."

          mkdir -p ./packaged-charts

          # Update Chart.yaml with pre-release version
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.rag-stack-version }}/" charts/rag-stack/Chart.yaml

          # Update dependencies and package
          helm dependency update charts/rag-stack/
          helm package charts/rag-stack/ --destination ./packaged-charts/

          echo "âœ… rag-stack packaged successfully"

      - name: ðŸ“¦ Package ai-platform-engineering Chart
        if: steps.version-check.outputs.skip != 'true' && steps.detect.outputs.ai-platform-changed == 'true'
        run: |
          echo "ðŸ“¦ Packaging ai-platform-engineering..."

          mkdir -p ./packaged-charts

          # Update Chart.yaml with pre-release version
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.ai-platform-version }}/" charts/ai-platform-engineering/Chart.yaml

          # If rag-stack was also changed, update its dependency version
          if [[ "${{ steps.detect.outputs.rag-stack-changed }}" == "true" ]]; then
            echo "ðŸ“ Updating rag-stack dependency version to ${{ steps.version.outputs.rag-stack-version }}"
            sed -i "/name: rag-stack/,/repository:/ s/version:.*/version: ${{ steps.version.outputs.rag-stack-version }}/" charts/ai-platform-engineering/Chart.yaml
          fi

          # CRITICAL: Always update rag-stack dependencies first
          # ai-platform-engineering depends on rag-stack, which depends on neo4j and milvus
          # These external dependencies must be downloaded regardless of path changes
          echo "Updating rag-stack dependencies..."
          helm dependency update charts/rag-stack/

          echo "Updating ai-platform-engineering dependencies..."
          helm dependency update charts/ai-platform-engineering/

          helm package charts/ai-platform-engineering/ --destination ./packaged-charts/

          # Verify dependencies are packaged correctly
          echo "ðŸ” Verifying rag-stack dependencies..."
          if tar -tzf charts/ai-platform-engineering/charts/rag-stack-*.tgz | grep -q "^rag-stack/charts/neo4j/Chart.yaml"; then
            echo "âœ… neo4j dependency verified"
          else
            echo "âŒ ERROR: neo4j missing from rag-stack package"
            exit 1
          fi

          if tar -tzf charts/ai-platform-engineering/charts/rag-stack-*.tgz | grep -q "^rag-stack/charts/milvus/Chart.yaml"; then
            echo "âœ… milvus dependency verified"
          else
            echo "âŒ ERROR: milvus missing from rag-stack package"
            exit 1
          fi

          echo "âœ… ai-platform-engineering packaged successfully with all dependencies"

      - name: ðŸš€ Push Pre-release Charts to GHCR
        if: steps.version-check.outputs.skip != 'true'
        run: |
          REGISTRY="oci://ghcr.io/${{ github.repository_owner }}/pre-release-helm-charts"

          echo "ðŸ“¦ Pushing pre-release charts to $REGISTRY"

          for CHART_FILE in ./packaged-charts/*.tgz; do
            if [ -f "$CHART_FILE" ]; then
              CHART_NAME=$(helm show chart "$CHART_FILE" | grep '^name:' | awk '{print $2}')
              CHART_VERSION=$(helm show chart "$CHART_FILE" | grep '^version:' | awk '{print $2}')

              echo "ðŸ“¦ Pushing $CHART_NAME:$CHART_VERSION"
              helm push "$CHART_FILE" "$REGISTRY"
              echo "âœ… $CHART_NAME:$CHART_VERSION published successfully!"
            fi
          done

      - name: ðŸ’¬ Comment on PR
        if: steps.version-check.outputs.skip != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const registry = `ghcr.io/${{ github.repository_owner }}/pre-release-helm-charts`;
            const ragStackChanged = '${{ steps.detect.outputs.rag-stack-changed }}' === 'true';
            const aiPlatformChanged = '${{ steps.detect.outputs.ai-platform-changed }}' === 'true';
            const headRepo = '${{ steps.pr-info.outputs.head_repo_full_name }}';
            const isFork = headRepo !== '${{ github.repository }}';
            const prNumber = parseInt('${{ steps.bump-status.outputs.pr_number }}');

            let body = `## ðŸ“¦ Pre-release Helm Charts Published\n\n`;

            if (isFork) {
              body += `> ðŸ”€ **Fork PR** - Published via \`helm-prerelease\` label\n\n`;
            }

            body += `**Registry:** \`${registry}\`\n\n`;

            if (ragStackChanged) {
              const version = '${{ steps.version.outputs.rag-stack-version }}';
              body += `### rag-stack\n`;
              body += `**Version:** \`${version}\`\n\n`;
              body += `\`\`\`bash\n`;
              body += `helm upgrade --install rag oci://${registry}/rag-stack --version ${version}\n`;
              body += `\`\`\`\n\n`;
            }

            if (aiPlatformChanged) {
              const version = '${{ steps.version.outputs.ai-platform-version }}';
              body += `### ai-platform-engineering\n`;
              body += `**Version:** \`${version}\`\n\n`;
              body += `\`\`\`bash\n`;
              body += `helm upgrade --install ai-platform oci://${registry}/ai-platform-engineering --version ${version}\n`;
              body += `\`\`\`\n\n`;
            }

            const headRef = '${{ steps.pr-info.outputs.head_ref }}';
            const isBranchTrigger = headRef.startsWith('prebuild/');
            const isLabelTrigger = !isBranchTrigger;

            body += `> **Note:** These pre-release versions will be automatically cleaned up when the PR is closed or merged.\n\n`;

            if (isLabelTrigger) {
              body += `> **Tip:** Remove the \`helm-prerelease\` label to immediately cleanup pre-release versions and stop publishing new ones.`;
            }

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
