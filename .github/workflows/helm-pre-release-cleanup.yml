name: "[Pre-Release] Helm Chart Cleanup"
description: "Cleanup pre-release Helm charts when PR is closed or label is removed"

on:
  pull_request_target:
    types: [closed, unlabeled]
    paths:
      - charts/**

permissions:
  contents: read
  packages: write

jobs:
  cleanup-pre-release:
    name: Cleanup Pre-release Charts
    runs-on: ubuntu-latest
    if: |
      (
        github.event.action == 'closed' &&
        (
          startsWith(github.event.pull_request.head.ref, 'prebuild/') ||
          contains(github.event.pull_request.labels.*.name, 'helm-prerelease')
        )
      ) ||
      (
        github.event.action == 'unlabeled' &&
        github.event.label.name == 'helm-prerelease'
      )

    steps:
      - name: üîê Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: üóëÔ∏è Delete Pre-release Chart Versions
        run: |
          # Get branch name and remove 'prebuild/' prefix if present
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          CLEAN_BRANCH=$(echo "${BRANCH_NAME#prebuild/}" | tr '/' '-' | tr '_' '-' | tr '[:upper:]' '[:lower:]')

          echo "üßπ Cleaning up pre-release versions for branch: $CLEAN_BRANCH"

          OWNER="${{ github.repository_owner }}"

          # Function to cleanup a chart
          cleanup_chart() {
            local CHART_NAME=$1
            local PACKAGE_NAME="pre-release-helm-charts/${CHART_NAME}"

            echo "üîç Checking ${CHART_NAME} for pre-release versions matching pattern: *-${CLEAN_BRANCH}-*"

            # Get package versions using GitHub CLI (for OCI packages)
            # Note: Forward slash in package name must be URL encoded as %2F
            gh api \
              "/orgs/${OWNER}/packages/container/$(echo "${PACKAGE_NAME}" | sed 's|/|%2F|g')/versions" \
              --jq '.[] | select(.metadata.container.tags[]? | test(".*-'${CLEAN_BRANCH}'-.*")) | {id: .id, tags: .metadata.container.tags}' > "${CHART_NAME}_versions.json" || true

            if [ -s "${CHART_NAME}_versions.json" ]; then
              echo "üóëÔ∏è Found ${CHART_NAME} pre-release versions to delete:"
              cat "${CHART_NAME}_versions.json"

              # Delete each version
              while IFS= read -r version; do
                VERSION_ID=$(echo "$version" | jq -r '.id')
                TAGS=$(echo "$version" | jq -r '.tags | join(", ")')

                echo "Deleting ${CHART_NAME} version $VERSION_ID with tags: $TAGS"

                gh api \
                  --method DELETE \
                  "/orgs/${OWNER}/packages/container/$(echo "${PACKAGE_NAME}" | sed 's|/|%2F|g')/versions/${VERSION_ID}" || true
              done < <(cat "${CHART_NAME}_versions.json" | jq -c '.')

              echo "‚úÖ ${CHART_NAME} pre-release cleanup completed"
            else
              echo "‚ÑπÔ∏è No ${CHART_NAME} pre-release versions found for branch: $CLEAN_BRANCH"
            fi
          }

          # Cleanup both charts
          cleanup_chart "rag-stack"
          cleanup_chart "ai-platform-engineering"

          echo "‚úÖ All pre-release chart cleanup completed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

