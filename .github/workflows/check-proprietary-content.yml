name: Check for Proprietary Content

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  check-proprietary-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history to compare against base branch

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*
          files_ignore: |
            .github/workflows/check-proprietary-content.yml
            .git_commit_msg.txt
            .cursorrules
            **/pyproject.toml
            .gitignore
            **/node_modules/**
            **/.git/**
            **/build/**
            **/dist/**
            **/.next/**
            **/coverage/**
            **/*.lock
            **/uv.lock
            **/yarn.lock
            **/package-lock.json

      - name: Check for Cisco/Outshift content
        id: check-content
        run: |
          echo "Checking for proprietary content in changed files..."

          # Define patterns to search for (case-insensitive)
          PATTERNS=(
            "cisco\.com"
            "@cisco"
            "outshift\.io"
            "outshift\.com"
            "outshift\.ai"
            "cisco-eti"
            "eti-sre"
            "eti_sre"
          )

          # Files to exclude from checks (regex patterns)
          EXCLUDE_PATTERNS=(
            "\.cursorrules$"
            "\.git_commit_msg\.txt$"
            "pyproject\.toml$"
            "CONTRIBUTING\.md$"
            "CODE_OF_CONDUCT\.md$"
          )

          # Initialize variables
          VIOLATIONS_FOUND=false
          VIOLATION_DETAILS=""

          # Check each changed file
          while IFS= read -r file; do
            # Skip if file doesn't exist or is binary
            if [ ! -f "$file" ]; then
              continue
            fi

            # Check if file should be excluded
            SKIP_FILE=false
            for exclude_pattern in "${EXCLUDE_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$exclude_pattern"; then
                SKIP_FILE=true
                break
              fi
            done

            if [ "$SKIP_FILE" = true ]; then
              continue
            fi

            # Check if file is binary
            if file "$file" | grep -q "binary"; then
              continue
            fi

            # Search for each pattern in the file
            for pattern in "${PATTERNS[@]}"; do
              if grep -iqE "$pattern" "$file"; then
                VIOLATIONS_FOUND=true
                matches=$(grep -inE "$pattern" "$file" || true)
                VIOLATION_DETAILS="${VIOLATION_DETAILS}\n\nüìÑ **File:** \`$file\`\n\`\`\`\n${matches}\n\`\`\`"
              fi
            done
          done <<< "${{ steps.changed-files.outputs.all_changed_files }}"

          # Set output
          if [ "$VIOLATIONS_FOUND" = true ]; then
            echo "violations_found=true" >> $GITHUB_OUTPUT
            # Save violation details to file for multi-line output
            echo "$VIOLATION_DETAILS" > /tmp/violation_details.txt
            echo "violations_file=/tmp/violation_details.txt" >> $GITHUB_OUTPUT
          else
            echo "violations_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with violations
        if: steps.check-content.outputs.violations_found == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const violationDetails = fs.readFileSync('/tmp/violation_details.txt', 'utf8');

            const body = `## ‚ö†Ô∏è Proprietary Content Detected

            This PR contains proprietary content that should not be in the open-source repository.

            ### Found Proprietary Content:
            ${violationDetails}

            ### Allowed Patterns:
            These patterns are allowed in specific files:
            - \`.cursorrules\` - Project-specific development rules
            - \`pyproject.toml\` - Maintainer information
            - \`.git_commit_msg.txt\` - Temporary commit message file
            - \`CONTRIBUTING.md\` - Contributor guidelines
            - \`CODE_OF_CONDUCT.md\` - Code of conduct

            ### How to Fix:
            1. **Generic Examples**: Replace company-specific examples with generic ones:
               - ‚ùå \`cisco.com\`, \`outshift.io\`
               - ‚úÖ \`example.com\`, \`your-domain.com\`

            2. **Email Addresses**: Use generic addresses:
               - ‚ùå \`user@cisco.com\`
               - ‚úÖ \`user@example.com\`

            3. **Group Names**: Use generic group names:
               - ‚ùå \`eti-sre\`, \`cisco-eti\`
               - ‚úÖ \`admin-group\`, \`your-admin-group\`

            4. **Internal URLs**: Remove or replace with placeholders:
               - ‚ùå \`https://outshift.io\`
               - ‚úÖ \`https://your-internal-domain.com\`

            ### Need Help?
            If you believe these detections are false positives or should be allowed, please:
            1. Explain why in a comment on this PR
            2. Add the file to the exclusion list in \`.github/workflows/check-proprietary-content.yml\`

            **This PR cannot be merged until these violations are resolved.**`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if violations found
        if: steps.check-content.outputs.violations_found == 'true'
        run: |
          echo "::error::Proprietary content detected in PR. Please remove Cisco/Outshift-specific content before merging."
          exit 1

      - name: Post success comment
        if: steps.check-content.outputs.violations_found == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ No proprietary content detected. This PR is clear for review!'
            });
