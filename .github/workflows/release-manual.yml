name: "[Release] Manual Version Release"
description: "Manually trigger a new release by specifying the version"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version to release (e.g., 0.2.9, 0.3.0, 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  # First: Sync all Chart.yaml versions
  sync-chart-versions:
    name: Sync Chart Versions
    uses: ./.github/workflows/helm-release-version-sync.yml
    with:
      version: ${{ github.event.inputs.version }}
    secrets: inherit

  # Then: Create the release
  release:
    name: Create Release
    needs: sync-chart-versions
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”’ Harden runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ“¥ Checkout repository (with synced Chart.yaml files)
        uses: actions/checkout@v6.0.1
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ“¦ Requested version: $VERSION"

          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ERROR: Version must be in semver format (e.g., 0.2.9, 0.3.0, 1.0.0)"
            echo "   Received: '$VERSION'"
            exit 1
          fi

          echo "âœ… Version format is valid"

      - name: ðŸ” Get current version and validate increment
        id: validate
        run: |
          # Extract current version from pyproject.toml
          CURRENT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          NEW_VERSION="${{ github.event.inputs.version }}"

          echo "ðŸ“‹ Current version: $CURRENT_VERSION"
          echo "ðŸ“¦ New version: $NEW_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Check if versions are the same
          if [[ "$NEW_VERSION" == "$CURRENT_VERSION" ]]; then
            echo "âŒ ERROR: New version ($NEW_VERSION) is the same as current version ($CURRENT_VERSION)"
            exit 1
          fi

          # Compare versions using sort -V (version sort)
          # The higher version should come last when sorted
          HIGHER=$(echo -e "$CURRENT_VERSION\n$NEW_VERSION" | sort -V | tail -n1)

          if [[ "$HIGHER" == "$CURRENT_VERSION" ]]; then
            echo "âŒ ERROR: New version ($NEW_VERSION) must be greater than current version ($CURRENT_VERSION)"
            echo "   Hint: At minimum, increment the patch version (e.g., $CURRENT_VERSION -> next patch)"
            exit 1
          fi

          # Check if tag already exists
          if git tag -l "$NEW_VERSION" | grep -q .; then
            echo "âŒ ERROR: Tag '$NEW_VERSION' already exists"
            exit 1
          fi

          echo "âœ… Version validation passed: $CURRENT_VERSION -> $NEW_VERSION"

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v4

      - name: ðŸ“¦ Install commitizen
        run: |
          uv tool install commitizen
          echo "âœ… Installed commitizen"

      - name: ðŸ“ Update version in pyproject.toml
        run: |
          NEW_VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ”„ Updating pyproject.toml version to '$NEW_VERSION'..."

          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" pyproject.toml

          # Verify the change
          UPDATED_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          if [[ "$UPDATED_VERSION" != "$NEW_VERSION" ]]; then
            echo "âŒ ERROR: Failed to update pyproject.toml"
            exit 1
          fi

          echo "âœ… Updated pyproject.toml to version $NEW_VERSION"

      - name: ðŸ“‹ Generate changelog with commitizen
        run: |
          NEW_VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ”„ Generating changelog for $NEW_VERSION using commitizen..."

          # Generate changelog for unreleased commits with the new version
          uv tool run cz changelog --unreleased-version "$NEW_VERSION"

          echo "âœ… Generated changelog entry for $NEW_VERSION"
          echo ""
          echo "ðŸ“‹ New changelog entry preview:"
          head -30 CHANGELOG.md

      - name: ðŸ”’ Regenerate uv.lock
        run: |
          echo "ðŸ”„ Regenerating uv.lock..."
          uv lock
          echo "âœ… uv.lock regenerated"

      - name: ðŸ” Review changes
        run: |
          echo "ðŸ“‹ Files modified:"
          git diff --stat
          echo ""
          echo "ðŸ“ Detailed diff for pyproject.toml:"
          git diff pyproject.toml

      - name: ðŸ“¤ Commit, tag, and push
        run: |
          NEW_VERSION="${{ github.event.inputs.version }}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage changes
          git add pyproject.toml CHANGELOG.md uv.lock

          # Commit with conventional commit format
          CURRENT_VERSION="${{ steps.validate.outputs.current_version }}"
          git commit -m "bump: version $CURRENT_VERSION â†’ $NEW_VERSION"

          # Create annotated tag
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"

          # Push commit and tag
          git push origin main
          git push origin "$NEW_VERSION"

          echo "âœ… Committed and pushed release $NEW_VERSION"
          echo ""
          echo "ðŸ·ï¸ Tag '$NEW_VERSION' created and pushed"

      - name: ðŸš€ Create GitHub Release (draft)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ”„ Creating draft GitHub Release for $NEW_VERSION..."

          gh release create "$NEW_VERSION" \
            --title "Release $NEW_VERSION" \
            --generate-notes \
            --draft

          echo "âœ… Draft release created (will be published after image builds complete)"

      - name: ðŸ”„ Trigger image builds and wait for completion
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ github.event.inputs.version }}"

          WORKFLOWS=(
            "ci-a2a-sub-agent.yml"
            "ci-a2a-rag.yml"
            "ci-mcp-sub-agent.yml"
            "ci-supervisor-agent.yml"
            "ci-agent-forge-plugin.yml"
          )

          echo "ðŸ”„ Triggering ${#WORKFLOWS[@]} CI workflows for tag $NEW_VERSION..."

          # Trigger all workflows
          for WF in "${WORKFLOWS[@]}"; do
            gh workflow run "$WF" --ref "$NEW_VERSION"
            echo "  âœ… Triggered $WF"
          done

          # Wait for runs to be registered in GitHub
          echo "â³ Waiting 15s for workflow runs to register..."
          sleep 15

          echo ""
          echo "â³ Waiting for all workflows to complete (this may take 20-30 minutes)..."
          echo ""

          FAILED=0
          SUCCEEDED=0

          for WF in "${WORKFLOWS[@]}"; do
            # Get the latest run for this workflow on this ref
            RUN_ID=$(gh run list --workflow="$WF" --branch="$NEW_VERSION" --limit=1 --json databaseId -q '.[0].databaseId')

            if [[ -z "$RUN_ID" || "$RUN_ID" == "null" ]]; then
              echo "  âš ï¸ $WF - no run found, skipping"
              continue
            fi

            echo "  â³ Watching $WF (run $RUN_ID)..."

            if gh run watch "$RUN_ID" --exit-status; then
              echo "  âœ… $WF completed successfully"
              SUCCEEDED=$((SUCCEEDED + 1))
            else
              echo "  âŒ $WF failed"
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "ðŸ“Š Results: $SUCCEEDED succeeded, $FAILED failed"

          if [[ $FAILED -gt 0 ]]; then
            echo ""
            echo "âŒ $FAILED workflow(s) failed - release remains as draft"
            echo "   Fix the issues and manually publish the release, or delete the draft and retry"
            exit 1
          fi

          echo "âœ… All image builds completed successfully"

      - name: ðŸ“¢ Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ github.event.inputs.version }}"

          echo "ðŸ”„ Publishing GitHub Release $NEW_VERSION..."
          gh release edit "$NEW_VERSION" --draft=false

          echo "âœ… Release published"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/$NEW_VERSION"

      - name: ðŸ“Š Summary
        run: |
          NEW_VERSION="${{ github.event.inputs.version }}"
          CURRENT_VERSION="${{ steps.validate.outputs.current_version }}"

          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Version | \`$CURRENT_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| New Version | \`$NEW_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`$NEW_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`main\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Modified" >> $GITHUB_STEP_SUMMARY
          echo "- \`charts/**/Chart.yaml\` - versions synced" >> $GITHUB_STEP_SUMMARY
          echo "- \`pyproject.toml\` - version updated" >> $GITHUB_STEP_SUMMARY
          echo "- \`CHANGELOG.md\` - changelog generated (commitizen)" >> $GITHUB_STEP_SUMMARY
          echo "- \`uv.lock\` - lock file regenerated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Builds Completed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- \`ci-a2a-sub-agent.yml\` - A2A sub-agent images" >> $GITHUB_STEP_SUMMARY
          echo "- \`ci-a2a-rag.yml\` - RAG component images" >> $GITHUB_STEP_SUMMARY
          echo "- \`ci-mcp-sub-agent.yml\` - MCP sub-agent images" >> $GITHUB_STEP_SUMMARY
          echo "- \`ci-supervisor-agent.yml\` - Supervisor agent image" >> $GITHUB_STEP_SUMMARY
          echo "- \`ci-agent-forge-plugin.yml\` - Agent Forge plugin image" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [Release $NEW_VERSION](https://github.com/${{ github.repository }}/releases/tag/$NEW_VERSION)" >> $GITHUB_STEP_SUMMARY

