# CAIPE Spec Kit - Cursor Rules

## Project Context

**CAIPE** (Community AI Platform Engineering) - pronounced like "cape" ðŸ¦¸ - is an open-source Multi-Agentic AI System (MAS) from the CNOE.io community. It enables Platform Engineers with AI-powered automation through specialized agents.

## Architecture Overview

```
Clients (Backstage, CLI, VSCode, CAIPE UI)
    â†“ HTTP/gRPC + A2A Protocol
Supervisor (Platform Engineer Orchestrator)
    â†“ A2A Protocol (Agent-to-Agent)
Sub-Agents (ArgoCD, GitHub, Jira, AWS, Splunk, etc.)
    â†“ MCP (Model Context Protocol)
MCP Servers â†’ External APIs
```

## Key Technologies

| Component | Stack |
|-----------|-------|
| Agents | Python 3.11+, LangGraph, LangChain |
| MCP Servers | FastMCP, httpx |
| Multi-Agent | A2A Protocol (Google), SSE streaming |
| UI | Next.js 16, React 19, Tailwind CSS |
| Deployment | Docker, Kubernetes, Helm |
| Tracing | Langfuse |
| Vector DB | Milvus |

## Repository Structure

```
ai-platform-engineering/
â”œâ”€â”€ ai_platform_engineering/
â”‚   â”œâ”€â”€ agents/                  # Domain-specific agents
â”‚   â”‚   â”œâ”€â”€ argocd/             # ArgoCD agent + MCP
â”‚   â”‚   â”œâ”€â”€ aws/                # AWS agent + MCP
â”‚   â”‚   â”œâ”€â”€ jira/               # Jira agent + MCP
â”‚   â”‚   â”œâ”€â”€ github/             # GitHub agent + MCP
â”‚   â”‚   â”œâ”€â”€ splunk/             # Splunk agent + MCP
â”‚   â”‚   â””â”€â”€ ...                 # Other agents
â”‚   â”œâ”€â”€ multi_agents/           # Multi-agent orchestration
â”‚   â”‚   â”œâ”€â”€ platform_engineer/  # Supervisor/Deep Agent
â”‚   â”‚   â””â”€â”€ supervisor/         # Base supervisor classes
â”‚   â”œâ”€â”€ knowledge_bases/        # RAG and knowledge management
â”‚   â”‚   â””â”€â”€ rag/               # Vector DB integration
â”‚   â””â”€â”€ utils/                  # Shared utilities
â”œâ”€â”€ ui/                         # CAIPE UI (Next.js)
â”œâ”€â”€ charts/                     # Helm charts
â”œâ”€â”€ docs/                       # Docusaurus documentation
â”‚   â””â”€â”€ docs/changes/          # Architecture Decision Records
â”œâ”€â”€ integration/                # Integration tests
â””â”€â”€ scripts/                    # Build and utility scripts
```

## A2A Protocol Events

When working with A2A protocol, use these artifact names:

| Artifact Name | Purpose |
|---------------|---------|
| `execution_plan_update` | Initial TODO-based execution plan |
| `execution_plan_status_update` | In-place plan updates |
| `execution_plan_streaming` | Token-by-token plan streaming |
| `tool_notification_start` | Tool/agent call started |
| `tool_notification_end` | Tool/agent call completed |
| `streaming_result` | Sub-agent response tokens |
| `partial_result` | Accumulated result |
| `complete_result` | Final complete response |

### Streaming Pattern
```python
# First chunk: replace content
{"append": False, "artifactId": "new-id", "text": "..."}

# Subsequent chunks: append to same artifact
{"append": True, "artifactId": "same-id", "text": "..."}
```

## Development Standards

### Conventional Commits (Required)
```
<type>(<scope>): <description>

Signed-off-by: Name <email@example.com>
```

Types: `feat`, `fix`, `docs`, `refactor`, `test`, `perf`, `build`, `ci`, `chore`

### DCO Sign-off (Required)
All commits must include Developer Certificate of Origin:
```bash
git commit -s -m "feat(agent): add new capability"
```

### Architecture Decision Records
Major changes should be documented in `docs/docs/changes/`:
- Format: `YYYY-MM-DD-descriptive-name.md`
- Include status: ðŸŸ¢ In-use, ðŸŸ¡ Proposed, ðŸ”´ Abandoned

## Agent Development Guidelines

### Creating a New Agent

1. Create directory structure:
```
ai_platform_engineering/agents/<agent_name>/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ agent.py           # LangGraph agent implementation
â”œâ”€â”€ prompts.py         # System prompts
â”œâ”€â”€ tools.py           # Agent tools
â””â”€â”€ mcp/              # MCP server
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ server.py     # FastMCP server
    â””â”€â”€ Dockerfile
```

2. Agent must inherit from base classes in `multi_agents/supervisor/`

3. Register in supervisor's available agents

### MCP Server Pattern
- Use FastMCP for tool definitions
- Implement pagination for large datasets (default: 20, max: 100)
- Add memory limits to prevent OOM
- Return structured responses with metadata

### LangGraph Agent Pattern
```python
from langgraph.graph import StateGraph
from typing import TypedDict

class AgentState(TypedDict):
    messages: list
    # ... other state fields

def create_agent():
    graph = StateGraph(AgentState)
    graph.add_node("process", process_node)
    graph.add_edge("process", END)
    return graph.compile()
```

## TODO-Based Execution Plans

Agents use TODO lists as execution plans:

```python
write_todos(
    merge=False,  # Initial plan
    todos=[
        {"id": "1", "content": "Task description", "status": "in_progress"},
        {"id": "2", "content": "Another task", "status": "pending"},
    ]
)
```

Status values: `pending`, `in_progress`, `completed`, `cancelled`

## Testing

```bash
# Run all tests
make test

# Agent-specific tests
make test-agent-argocd
make test-mcp-jira

# Integration tests
make quick-sanity
make argocd-sanity
```

## Spec Kit Usage

### Creating Specs

1. Create spec file in `.specify/specs/`
2. Use template from `.specify/templates/spec.md`
3. Define acceptance criteria
4. Update as implementation progresses

### Spec Categories

- **Agent Specs**: New agent implementations
- **MCP Specs**: Tool additions and enhancements
- **Multi-Agent Specs**: Orchestration patterns
- **Integration Specs**: Cross-cutting concerns

## Related Documentation

- **ADRs**: `docs/docs/changes/` - Architectural decisions
- **UI Specs**: `ui/.specify/` - UI-specific specifications
- **Constitution**: `.specify/memory/constitution.md` - Core principles
- **Prompt Library**: Curated prompts in Helm chart data

## Quick Commands

```bash
# Run supervisor
make run

# Run UI
make caipe-ui

# Generate docker-compose
make generate-docker-compose PERSONAS="p2p-basic"

# Lint code
make lint

# Format code
make lint-fix
```

## Environment Variables

Key environment variables (see `.env.example`):
- `OPENAI_API_KEY` / `ANTHROPIC_API_KEY` - LLM API keys
- `MODEL_NAME` - LLM model to use
- `AGENT_HOST` / `AGENT_PORT` - Agent binding
- MCP server URLs for each agent
- RAG configuration (Milvus, Redis, Neo4j)

## Security Considerations

- Never hardcode credentials
- Use environment variables or secrets management
- Implement RBAC at API level
- Validate all external inputs
- Follow cryptographic guidelines (see workspace rules)
