cspm post mortem
nginx lightspin
post mortem
2024-02-13; Nginx controller OOM failure on lightspin-prod
¶
Summary
¶
Lightspin Prod faced an outage due to NGINX controller resource deprevation
When
¶
2024-02-13 22:10 IST - 2024-02-13 23:55 IST
Timeline
¶
2024-02-13
22:10 IST - SRE were notified by lightspin dev team on the issue
22:15 IST - Lightspin team bypassed the nginx ingress they were using by redirecting the API GW to an ALB they have inlace; app was reachable from that point
22:20 IST - SRE continued the investigation with lightspin dev's to find the RC, as it seemed to be a high resource utilization by the nginx controller
22:25 IST - SRE suggested to increase the resource limit qouta on ingress-nginx namespace
22:36 IST - lightspin team modified the ingress-nginx controller resources as well
https://wwwin-github.cisco.com/eti/sre-cluster-configs/pull/2026
23:00 IST - change did not take effect as ArgoCD didnt sync on the change
23:50 IST - SRE team manually synced the change and increased resource-limit-quota on ingress-nginx and ingress-nginx-internal namespace
23:55 IST - Issue was temporarily resolved and was communicated via the public SRE for lightspin space
Impact
¶
System(s) impacted?
¶
Lightspin Prod environment on lightspin-prod-1 cluster
Teams impacted?
¶
Lightspin
Analysis
¶
- NGINX controller crashed after high Memory utilization , using the old NGINX version (1.5.1) might have contributed to this as well as in newer versions some memory leaks were fixed.
Solution:
    - As a short term solution (before upgrading the prod NGINX version) we increased the resource-limits-quota on the relevant namespaces and increased the resources requeast/limits inside the app deployment itself
Takeaways
¶
- Alerting\incident response and shared responsibility should be discussed for building a clear process for much faster mitigation time. [Tracking Jira](https://cisco-eti.atlassian.net/browse/SRE-7597)
- We are monitoring https://console.panoptica.app with https://observability.eticloud.io/goto/Q5PTkY2Sg?orgId=1, but we did not get paged that the site was down, so we need Lightspin team to provide us an endpoint to monitor like console.panoptica.app/health that is unauthenticated
- Route dedicated SRE services alerts (Nginx/Karpenter/Harbor etc) to SRE on-call
- Discuss the possibility of using external ALB instead of In-cluster NGINX specially for Prod and high memory consuming environments.
- Upgrade lightspin nginx ingress controller to at least v4.9.1. [Tracking Jira](https://cisco-eti.atlassian.net/browse/SRE-7596)
2024-02-22