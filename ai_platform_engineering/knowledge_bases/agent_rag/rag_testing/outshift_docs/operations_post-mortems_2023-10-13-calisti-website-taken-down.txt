DNS postmortem
TLS postmortem
post mortem calisti
2023-10-13; SRE-6627 (deploy redirector for calisti apps); calisti.app website taken down
¶
Summary
¶
While working on
SRE-6627 (deploy redirector for calisti apps)
,
https://calisti.app
was taken down by a DNS change
performed in AWS Route53.
When
¶
The incident occured on Friday the 13
th
of October, at 6.10pm CET.
Timeline
¶
2023-10-13
¶
1700 CET - Ongoing work on the
websites-redirector
to include redirects for 5 calisti related hostnames:
calisti.app
www.calisti.app
cloud.calisti.app
console.calisti.app
staging.calisti.app
To
outshift.com
1730 CET -
calisti.app
and
staging.calisti.app
redirected to
outshift.com
following the merge of
this PR
in order to deploy changes made to
websites-redictor
in
eks-prod-3
.
1755 CET - Ongoing investigation to understand why the other hostnames (
console.calisti.app
,
cloud.calisti.app
and
www.calisti.app
) did
not
redirect to
outshift.com
(they both kept showing their respective web page).
During the aforementioned investigation, David Bouchare realises that
www.calisti.app
has a CNAME pointing to
www.calisti.app.edgesuite.net
(Akamai CDN).
1800 CET - As per the websites-redirector's documentation, the DNS Alias record of
www.calisti.app
was updated to point to the
websites-redirector
classic ELB in Route53 ().
Immediately after this change, both
https://calisti.app
and
https://www.calisti.app
start returning a TLS related error and the calisti webpage is no longer displayed.
1820 CET - Investigation begins on a WebEx video call with Sri, Matt joining the call shortly after. Sri investigates the
websites-redirector
and the
cert-manager
running in
eks-prod-3
, with ArgoCD's UI. The certificate resource of the websites-redirector shows issues in its status (not all TLS certs are in sync). The
cert-manager
shows issues with some
challenge
resources
.
Sri deletes the problematic challenges, which restores access to
https://www.calisti.app
and
https://calisti.app
.
1900 CET - After a short discussion about
hostname collisions
, it was identified that we needed to take down all Calisti SaaS apps that had Ingress resources deployed in
eks-prod-3
. Some of those had hostnames that prevented the successful redirection to
oushift.com
(namely
console.calisti.app
and
cloud.calisti.app
).
A
PR
is created to take care of this.
2023-10-14
¶
1430 CET - The above PR is merged post review. Calisti SaaS apps are being removed by ArgoCD (the corresponding Kubernetes resources) and
staging.calisti.app
as well as
console.calisti.app
redirect to
outshift.com
as expected.
Impact
¶
The main calisti website
calisti.app
(and
www.calisti.app
) was taken down.
System(s) impacted?
¶
websites-redirector
in
eks-prod-3
cert-manager
in
eks-prod-3
calisti
website
Teams impacted?
¶
The Calisti teams as well as the SRE team.
Analysis
¶
Detailed descriptions of what went wrong. This can include:
Technical failures
¶
The
website-redirectors
and
cert-manager
lacked Kubernetes event monitoring/alerting in order to notice whether one of its kubernetes resources is having issues. Especially for the below k8s resources:
-
Certificate
with
.status.conditions[].reason
and
.status.conditions[].message
. This may also be monitorable with metrics/time-series.
-
Challenge
Process failures
¶
Rolling out these DNS changes were made without an observer, and without following the SRE Production Environment Changes(../../onboarding/sre-team/production_changes.md) procedure which was not in place yet.
Not having tests for TLS certificate changes and DNS record updates.
Human failures
¶
Immediately changing the DNS record for
www.calisti.app
without testing the implication of the actual change beforehand.
Takeaways
¶
This incident provides an opportunity to develop a better understanding of the implications of a TLS certificate update when rolling out a DNS record update, and how the order of operations matter.
2023-10-18