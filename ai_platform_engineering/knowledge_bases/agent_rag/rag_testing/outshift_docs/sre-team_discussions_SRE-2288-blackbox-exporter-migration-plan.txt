BlackBox exporter migration plan
¶
Migration Steps
Overview
¶
Migrate monitoring of
publicly accessible
ETI URLs from eti-sre-monitoring to eks-observability-1 cluster.
Change GitOps workflow from ansible scripts to kubernetes manifests
No change in monitoring for Cisco internal URLs. They will continue to be monitored from eti-sre-monitoring.
Goals
¶
We currently monitor both internally and externally hosted sites via the BlackBox exporter running on eti-sre-monitoring, which is hosted internally. Due to regularly occurring network connectivity issues from inside Cisco to external sites, we will migrate monitoring of externally hosted sites to the BlackBox exporter running in eks-observability-1 and configure alerting and dashboards in that cluster. The internal monitoring server will continue to be used for internally hosted sites. eks-observability-1 additionally provides availability benefits as well as a GitOps workflow for management.
Current Setup
¶
Our current config in eti-sre-monitoring:
We currently have 3 main groups called blackbox_prod, blackbox_dev and blackbox_post. We keep our inventory of URLs in this
file
. This is automatically done if the build infra is updated and should be run once updating the monitoring playbook, first in the canary cluster and once ok, applied to eti-sre-monitoring.
blackbox_prod group has all the production URls
blackbox_dev group has all the dev URls
the example of the module with syntax can be found below:
http_post_2xx
:
prober
:
http
timeout
:
5s
http
:
method
:
POST
valid_status_codes
:
[
401
]
preferred_ip_protocol
:
ip4
New Setup
¶
New setup for eks-observability-1 cluster
¶
Our current production blackbox exporter setup in eks-observability-1 document can be found
here
.
values.yaml
in our current setup for eks-observability-1 cluster has probes.urls where we add or modify URLs.
The new setup
will have the new probes value below:
probes
:
-
name
:
eti-prod
module
:
http_2xx
urls
:
-
"https://docs.eticloud.io/"
-
"https://techblog.cisco.com/"
-
"https://ciscotechblog.com/"
-
"https://ciscodesignpartners.com/"
-
"https://www.ciscodesignpartners.com/"
-
"https://harbor.eticloud.io/"
-
"https://eti.cisco.com"
-
"https://kubernetes-charts.banzaicloud.com/"
-
"https://one-eye.prod.eticloud.io/"
-
name
:
eti-dev
module
:
http_2xx
urls
:
-
"https://maestro-api.dev.eticloud.io/"
-
"https://maestro-ui.dev.eticloud.io/"
-
"https://canary-test.eks-production-1.prod.eticloud.io"
-
"https://canary-test.eks-production-2.prod.eticloud.io"
-
"https://staging.ciscotechblog.com/"
-
"https://staging.ciscodesignpartners.com/"
-
"https://staging-eti.eticloud.io/"
# snm-docs doesn't need authentication so moved to GET group instead of POST group
-
"https://smm-docs.eticloud.io/"
-
name
:
eti-post-urls
module
:
http_post_2xx
urls
:
-
"https://wcm-docs.eticloud.io/"
-
"https://mcom-docs.eticloud.io/"
-
"https://sdm-docs.eticloud.io/"
-
"https://asg-docs.eticloud.io/"
-
"https://kdm-docs.eticloud.io/"
-
"https://maestro-docs.eticloud.io/"
Migration Steps
¶
Create a new module for POST urls. PR was created
here
Add new probes config above to
values.yaml
.  Basically, we will add two more groups called eti-dev and eti-post-urls
Add
custom alert rules
for eti-dev and eti-post-urls groups.  We only have eti-prod alert rules at this moment.
A PR for step 3 and 4 is created
here
The PR on step 5 needs to be reviewed and approved before going to step 7.
Coordinate with person
on call
on webex before doing testing.
Create an invalid site such as
https://abcdefgh.com/
and do a PR to trigger an alert.
Need to disable the alert grouping for alertmanager using this syntax group_by: ['...'] before proceeding step 10
If everything is working fine, We will do a PR to remove all the URLs from eti-sre-monitoring except wwwin-github.cisco.com and containers.cisco.com.
URLs Not Migrating
¶
https://wwwin-github.cisco.com/eti/
https://containers.cisco.com/organization/eti-sre
https://dev.ciscodesignpartners.com
We will keep the above links since are they cisco internal urls that can't be accessed from internet.  In future we can migrate those urls to the new kubernetes in our P3 network.
Here is our
Prometheus Blackbox Exporter Dashboards
2023-08-25