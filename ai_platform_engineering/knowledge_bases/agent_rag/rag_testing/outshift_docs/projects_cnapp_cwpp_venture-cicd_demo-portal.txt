CWPP demo portal
Panoptica demo porta
Demo Portal Deployment
¶
The Panoptica demo portal utilizes the blue/green CD process to remove downtime of the site availability. In order to achieve a smooth transition from a
green
(newly deployed) namespace to the
blue
(currently used) namespace, we utilize the new
GKE Gateway API
(which is being rolled out to kubernetes platform for all clouds, for more info click
here
).
In addition to this, the Gateway API acts as our ingress to the GKE cluster, allowing integration with other GCP SaaS tools, such as WAF configurations, SSL policies, GCP managed certificates, and more.
Proposed Solutions
¶
The SRE team came up with a few proposed solutions for the need of blue/green and/or canary deployments for the demo portal. The one being used now is the
Gateway API
. With plans to move to ArgoCD in the future. Which this solution will allow.
High Level Architecture
¶
As seen in the high level architecture, the
Gateway API
allows for separation of responsibilities between "infra ops" (via
gateway policies
- which are used for security and site reliability, and
traffic management
- which are used for such use cases like blue/green/canary etc.) and development (via
httproutes
- which are used to control their services and connect them to one central gateway)
This architecture allows us to apply integrations like
Cloud Armor
(WAF),
GCP Managed Certificates
, and
SSL Policies
.
CD Pipeline
¶
As of now, we utilize the Jenkins
Demo Portal Pipeline
to achieve the blue/green deployment flow. We will strive to change this to ArgoCd when the opportunity arrives.
Sequence Diagram
¶
The following sequence diagram shows the flow of the Jenkins pipeline deployment and how it switches between the blue/green deployments/namespaces.
Operational Notes
¶
There are a few things to note if you are to move/recreate/deploy to a new cluster:
The Gateway API needs to be installed manually on the cluster
PRIOR
to using the deployment pipeline.
The blue/green namespaces need to be created and labeled
PRIOR
first time deployment.
The
gateway-infra
namespace and gateway resources are applied via
kubectl
commands during Jenkins deployment pipeline
The gateway uses a
static IP address
that can be found
here
under
demo-portal-static-ip
Note
This IP address should not be changed, this external address was allocated regardless of cluster/location
If a new certificate was created for the [
*.demo.panoptica.app,demo.panoptica.app
] domains, you need to make sure to create/update your map entries for that certificate. To do this you should follow these steps:
Upon creation of the certificate, create a new cert map:
gcloud
certificate-manager
maps
create
<CERTIFICATE
MAP
NAME>
After creating the cert map, create new entries for
demo.panoptica.app
and
preview.demo.panoptica.app
gcloud
certificate-manager
maps
entries
create
demo-panoptica-app-map-entry
\
--map
=
"<CERTIFICATE MAP NAME>"
\
--certificates
=
"<CERTIFICATE NAME>"
\
--hostname
=
"demo.panoptica.app"
gcloud
certificate-manager
maps
entries
create
preview-demo-panoptica-app-map-entry
\
--map
=
"<CERTIFICATE MAP NAME>"
\
--certificates
=
"<CERTIFICATE NAME>"
\
--hostname
=
"preview.demo.panoptica.app"
Make sure to update the
gateway.yaml
file
to include the new cert map you created from earlier.
The WAF rule was created outside the cluster configurations/helm charts,
here
, and was attached to the gateway via
Gateway Policy
here
under
securityPolicy
The
SSL Policy
was also attached via
Gateway Policy
, but resides in the
gateway.yaml
file
, so it can always be changed without effects to the deployment.
The policy currently used can be found
here
Health check policy configured via
Gateway Policy
, can be found
here
2024-02-25