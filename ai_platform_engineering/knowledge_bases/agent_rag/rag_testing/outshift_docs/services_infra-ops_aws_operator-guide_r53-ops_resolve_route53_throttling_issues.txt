How to resolve Route53 throttling issues
¶
Usually the first indication of this problem thet external-dns pods are crashing and there are
KubePodCrashLooping
alerts triggered.
Incident
#25377
eks-gitops-cnapp-1: KubePodCrashLooping: was triggered by the Prometheus service and assigned to Dev Null.
1. Look for "Throttling: Rate exceeded" log messages in external-dns logs
¶
The errors can come from any cluster, so this won't help you to identify that
which cluster exceeds the Route53 API limit, but you can verify if there is
any issue with Route53 throttling.
2. Try to identify the source cluster with CloudTrail
¶
Log in into the eticloud account, and choose the
us-east-1
region.
A CloudTrail trail was set up to deliver the events into the
aws-cloudtrail-logs-626007623524-7d24d050
,
we can query these events from Athena.
Open Athena and choose the
default
database.
Run the following query:
SELECT sourceipaddress, awsregion, COUNT(1)
FROM "default"."cloudtrail_logs_aws_cloudtrail_logs_626007623524_7d24d050"
WHERE
eventname = 'ListResourceRecordSets' AND
date_parse(eventtime, '%Y-%m-%dT%H:%i:%sZ') > current_date - interval '7' day
GROUP BY sourceipaddress, awsregion
ORDER BY COUNT(1)
The results of the query is the number of overall
ListResourceRecordSets
API calls in a given time period
by source IP address.
In this example as you can see most of the clusters sent 60-80.000 API calls in seven days,
but there is an outlier (
3.133.228.122
) that send more than 200.000 API calls, 2-3 times more
than the other clusters. Probably this is the source of the excessive Route53 API requests.
The IP address the VPC's NAT Gateway's IP address, based on that you need to identify the AWS account, region, VPC, and the cluster (hint: Terraform state files).
3. Update the external-dns configuration on the cluster
¶
There are multiple ways to do this, and it always depends on context (how many teams using that cluster, frequency of the record changes, is it a shared cluster, etc).
If too frequent ingress and\or service object changes are triggering the Route53 syncronization, then you can try to disable to trigger a sync loop on these events. In order to do that remove these lines from the external-dns configuration:
triggerLoopOnEvent: true
sources:
- ingress
- service
If external-dns tries to update too many zones at the same time, and the cluster only uses a limited number of domains, add domain filters:
extraArgs:
- "--domain-filter=eticloud.io"
- "--domain-filter=staging.eticloud.io"
4. Verify is the updated config solves the issue
¶
Go back to the logs (step 1), and you should see that after updating the external-dns configuration the throttling errors should be gone.
2023-12-05