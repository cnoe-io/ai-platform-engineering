Renew certificates on the old GCP Kubernetes cluster
¶
Prerequisites
¶
Google Cloud SDK
kubectl
kubectx
kubectl-neat
TL;DR:
brew
install
google-cloud-sdk
kubernetes-cli
krew
gke-gcloud-auth-plugin
kubectl
krew
install
ctx
ns
neat
Note:
installing Krew might be more complicated than that. Check out the
official documentation
.
Note:
installing gke-gcloud-auth-plugin is now mandatory as bet
GKE v1.26 official documentation
.
Steps
¶
Log in to GCP with your Cisco account:
gcloud auth login
Make sure you have access to the Banzai Infra Paas (infra-paas) project:
gcloud projects list
Log in to the
infra-live
cluster:
gcloud container clusters get-credentials infra-live --region us-central1 --project infra-paas
If you already logged in earlier, make sure to select the correct context:
kubectl ctx gke_infra-paas_us-central1_infra-live
Run the following commands to trigger certificate renewals:
kubectl
-n
certs
get
secret
cert-banzaicloud-com
-o
yaml
|
kubectl
neat
|
sed
's/namespace: .*/namespace: chartmuseum/; s/name: cert-banzaicloud-com/name: chartmuseum-traefik-default-cert/; s/type: .*//'
|
kubectl
apply
-f
-
kubectl
-n
chartmuseum
rollout
restart
$(
kubectl
-n
chartmuseum
get
deploy
-l
"app=traefik"
-o
name
)
The output should look something like this:
secret/chartmuseum-traefik-default-cert changed
deployment.apps/chartmuseum-traefik restarted
Monitor the following URLs and make sure they get back up:
https://kubernetes-charts.banzaicloud.com
(this is the most important one)
Verify that the certs are valid for at least two months:
echo
|
openssl
s_client
-connect
kubernetes-charts.banzaicloud.com:443
-servername
kubernetes-charts.banzaicloud.com
2
>/dev/null
|
openssl
x509
-noout
-dates
Note:
Cert Manager automatically renews certificates when they expire, so
notBefore
dates might not match the current date.
Explanation
¶
This particular cluster uses Traefik v1 as ingress controller with wildcard certificates issued by Cert Manager.
Unfortunately, certificates have to be copied to the relevant namespaces manually (don't ask why...history).
Since Traefik does not reload certificates automatically, it has to be restarted after copying certs.
To make things more complicated, the different production services have their own ingress controllers (don't ask why...history).
2022-12-19