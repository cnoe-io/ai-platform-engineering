jenkins k8s cluster automatioin
Jenkins K8s Cluster kubectl access for automation
Â¶
Development/Self-service Kubernetes clusters can be access via Jenkins automation using Vault AWS Credentials
Here are some sample jobs
Self-service clusters
Greatbear cluster
Sample Jenkins Code
@Library
([
'srePipeline'
])
_
def
globalparams
=
[
VAULT_ADDR:
'https://keeper.cisco.com'
,
vaultAuthType:
'vaultToken'
,
]
pipeline
{
agent
{
docker
{
image
sreUtils
.
getDockerImage
(
globalparams
.
overridePipelineDockerVersion
)
label
globalparams
.
overrideDockerLabel
?
globalparams
.
overrideDockerLabel
:
sreUtils
.
getJenkinsNodeLabel
()
args
sreUtils
.
getDockerCmdString
()
registryUrl
sreUtils
.
getPipelineDockerRegistry
()
registryCredentialsId
sreUtils
.
getJenkinsRegistryCreds
()
}
}
stages
{
stage
(
"Prepare"
)
{
steps
{
script
{
sreUtils
.
figlet
(
"Prepare"
)
globalparams
=
globalparams
<<
params
}
}
}
stage
(
'eks-gb-dev-1'
)
{
steps
{
script
{
sreUtils
.
figlet
(
"eks-gb-dev-1"
)
def
vaultparams
=
[
awsVaultEnv:
'aws_eticloud'
,
accountId:
'626007623524'
,
roleName:
'greatbear'
,
]
globalparams
=
globalparams
<<
vaultparams
sreAWS
.
awsLogin
(
globalparams
,
'great-bear'
)
{
sh
'''
set -x
rm -rf /home/ubuntu/.aws
aws eks update-kubeconfig --name eks-gb-dev-1 --region eu-west-1
kubectl get pods -A
'''
}
}
// script
}
// steps
}
// stage
stage
(
'eks-gbear-1'
)
{
steps
{
script
{
sreUtils
.
figlet
(
"eks-gbear-1"
)
def
vaultparams
=
[
awsVaultEnv:
'aws_eticloud_scratch'
,
accountId:
'380642323071'
,
roleName:
'gbear'
,
]
globalparams
=
globalparams
<<
vaultparams
sreAWS
.
awsLogin
(
globalparams
,
'gbear'
)
{
sh
'''
set -x
aws eks update-kubeconfig --name eks-gbear-1 --region eu-west-1
kubectl get pods -A
'''
}
}
// script
}
// steps
}
// stage
}
//stages
post
{
always
{
cleanWs
()
}
// always
}
// post
}
// pipeline
2023-09-21