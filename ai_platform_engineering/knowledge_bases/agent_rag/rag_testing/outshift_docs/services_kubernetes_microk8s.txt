P3 microk8s playbook
microk8s setup
Microk8s K8s
¶
Kubectl access
¶
Tip
Use
Kubectl Bash Helper
to setup P3 Kubectl access
Setup
¶
1. Create Nodes via terraform
¶
sre-tf-infra
2. Run Ansible
¶
sre-build-infra-ansible
3. Update Security Groups Rules
¶
4. Create microk8s control plane
¶
sudo snap install microk8s --classic
microk8s status --wait-ready
sudo usermod -a -G microk8s ubuntu
sudo chown -R ubuntu ~/.kube
newgrp microk8s
5. Retrieve kubeconfig
¶
microk8s config
Store in Keeper
Tip
Use
Kubectl Bash Helper
to setup P3 Kubectl access
Setup Baseapps
¶
sre-cluster-configs
ArgoCD
Grafana
Setup iptable rules
¶
kubectl command to get ingress-nginx nodeports for 80 and 443
kubectl get svc -n ingress-nginx
Output
NAME                                                TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)                      AGE
p3-prod-alln-1-ingress-nginx-controller             LoadBalancer   10.152.183.107   10.123.184.174   80:32080/TCP,443:32443/TCP   8d
p3-prod-alln-1-ingress-nginx-controller-admission   ClusterIP      10.152.183.78    <none>           443/TCP                      8d
sudo iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 443 -j REDIRECT --to-port 32443
sudo iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 80 -j REDIRECT --to-port 32080
Verify iptables rules
ubuntu@p3-ctrl-prod-alln-1:~$ sudo iptables -t nat -L
# Warning: iptables-legacy tables present, use iptables-legacy to see them
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination
DOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL
REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:https redir ports 32443
REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:15432 redir ports 30420
REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:postgresql redir ports 32654
REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:15432 redir ports 30420
REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:postgresql redir ports 32654
REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:15432 redir ports 30420
Setup Metallb
¶
microk8s enable metallb
microk8s status
microk8s enable metallb:10.123.184.174/32
â¦ â¯ kubectl get svc -n ingress-nginx
NAME                                                TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)                      AGE
p3-prod-alln-1-ingress-nginx-controller             LoadBalancer   10.152.183.107   10.123.184.174   80:32080/TCP,443:32443/TCP   8d
2024-06-07