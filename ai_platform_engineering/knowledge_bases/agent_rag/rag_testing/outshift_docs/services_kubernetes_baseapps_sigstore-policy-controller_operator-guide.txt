baseapps
operator guide
sigstore policy controller
Operator Guide
¶
Resolving "server key missing", "TLS handshake error" error
¶
There is a known race condition with the certificates in the Helm chart that can happen when it is reinstalled or upgraded:
-
Cosigned Helm Chart - tls: no certificates configured #369
-
policy-webhook-certs secrets are not getting created #41
âYou need to manually delete the leases kubectl delete leases -n cosign-system when you face this issue server key missing. They are automatically deleted but it takes some time until the leases are automatically cleaned up. We cannot automatize this cleanup, it sometimes happens during the upgrade.â
The problem that leases aren not deleted from a previous deployment:
â¯ kubectl get leases
NAME                                                                                                            HOLDER                                                                                                 AGE
policy-controller.defaulting.clusterimagepolicy.sigstore.dev.00-of-01                                           vowel-dev-1-sigstore-policy-controller-webhook-54bff97645-g8h7b_19b695ca-c0d7-4c45-a338-4dab3118134e   10d
policy-controller.github.com.sigstore.policy-controller.pkg.reconciler.clusterimagepolicy.reconciler.00-of-01   vowel-dev-1-sigstore-policy-controller-webhook-54bff97645-g8h7b_f9c3c465-7cb1-4958-9d6f-f50fa95fbf2e   10d
policy-controller.github.com.sigstore.policy-controller.pkg.reconciler.trustroot.reconciler.00-of-01            vowel-dev-1-sigstore-policy-controller-webhook-54bff97645-g8h7b_9220aa38-396b-42d2-8b9c-b1f8b3794bda   10d
policy-controller.policy.sigstore.dev-mutating.00-of-01                                                         vowel-dev-1-sigstore-policy-controller-webhook-54bff97645-g8h7b_cc2a7c70-2d84-442d-8511-58614c47eab3   10d
policy-controller.policy.sigstore.dev-validating.00-of-01                                                       vowel-dev-1-sigstore-policy-controller-webhook-54bff97645-g8h7b_5e6cb26c-f84d-4348-8d15-85700c4f690b   10d
policy-controller.resource-conversion.00-of-01                                                                  vowel-dev-1-sigstore-policy-controller-webhook-54bff97645-g8h7b_24de19a0-9557-46c4-90f9-fc01bf7ec636   10d
policy-controller.validating.clusterimagepolicy.sigstore.dev.00-of-01                                           vowel-dev-1-sigstore-policy-controller-webhook-54bff97645-g8h7b_c8776467-cc87-4289-a525-62af013b34b8   10d
policy-controller.webhookcertificates.00-of-01                                                                  vowel-dev-1-sigstore-policy-controller-webhook-54bff97645-g8h7b_cb1a2e4d-ae66-48fb-9ec5-df55ea6c7bf3   10d
To resolve this error:
Leases have to be deleted manually:
kubectl -n sigstore-policy-controller delete leases --all
The sigstore-policy-controller has to be deleted and reinstalled
Error from server: conversion webhook for policy.sigstore.dev/v1alpha1 error
¶
Error from server: conversion webhook for policy.sigstore.dev/v1alpha1,
Kind=ClusterImagePolicy failed: Post "https://webhook.sigstore-policy-controller.svc:443/resource-conversion?timeout=30s":
service "webhook" not found
It is a known issue, a deadlock can happen when the sigstore-policy-controller deleted:
Custom resources with finalizers can "deadlock" customresourcecleanup.apiextensions.k8s.io finalizer #60538
Resolution:
Find the
clusterimagepolicies.policy.sigstore.dev
CRD and remove the conversion strategy from
Webhook
to
None
:
spec:
conversion:
strategy: Webhook
webhook:
clientConfig:
caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNpVENDQWkrZ0F3SUJBZ0lSQU1UKy9ORlY0VVM4QmlmTG5QdEZ5Zjh3Q2dZSUtvWkl6ajBF$
service:
name: webhook
namespace: sigstore-policy-controller
path: /resource-conversion
port: 443
conversionReviewVersions:
- v1beta1
- v1alpha1
group: policy.sigstore.dev
---
spec:
conversion:
strategy: None
group: policy.sigstore.dev
Retrieve the ClusterImagePolicy resources and remove the finalizers
The step above should resolve the issue, if not then get all the ClusterImagePolicy resources:
kubectl get ClusterImagePolicy -A -o yaml
Remove the finalizers:
kubectl patch ClusterImagePolicy/NAME -p '{"metadata":{"finalizers":[]}}' --type=merge
2023-10-03