harbor.eticloud.io is moved to new cluster
¶
What:
harbor.eticloud.io is being moved to a new production cluster
When:
June 30
th
2022, 1.30PM US Central time (GMT-6)
Impact:
harbor.eticloud.io will be unavailable during this time
Here is the approved migration plan
Background
¶
harbor.eticloud.io is currently hosted on eks-production-1
eks-production-1 is being
replaced
with eks-prod-1 due to
CVE-2021-25741
harbor.eticloud.io also uses in-cluster postgres which is not backed-up
Move harbor data to Aurora RDS in AWS
Harbor Access during migration
¶
Database and EBS volume migration involves taking snapshots and restoring them in the target cluster, hence SRE team will take a short maintenance window to perform harbor migration.
Harbor will be in readonly mode during this upgrade
Change Plan
¶
June 30
th
2022 - 0710 CST:
Harbor is put in read only mode
June 30
th
2022 - 0722 CST:
Harbor eks-production-1 postgres data backed up
June 30
th
2022 - 0723 CST:
Harbor eks-production-1 harbor-harbor-postgres pvc ebs snapshot initiated
June 30
th
2022 - 0732 CST:
Harbor eks-production-1 EBS volume created from snapshot
â ï¸ Discard this volume as it is in us-east-2
Deleted this volume
June 30
th
2022 - 0748 CST:
Copy snapshot from us-east-2 to us-west-2
June 30
th
2022 - 0805 CST:
Snapshot rds-prod-1
June 30
th
2022 - 0809 CST:
Restore harbor databases
regitry db
notarysigner db
notaryserver db
June 30
th
2022 - 0829 CST:
Harbor eks-production-1 EBS volume created from snapshot
June 30
th
2022 - 0838 CST:
Harbor eks-prod-2 create pv an pvc
June 30
th
2022 - 0904 CST:
Harbor eks-prod-2 helm install
June 30
th
2022 - 0930 CST:
Data validation
harbor.eticloud.io-tests git update
[Jenkins builds]
Basic access test run #134
Detailed test run #31
Migration test run #5
Robots login test run #3
June 30
th
2022 - 0945 CST:
Discovered chart museum is not migrated
Migrating chartmuseum, jobservice, trivy pvc
2023-10-16