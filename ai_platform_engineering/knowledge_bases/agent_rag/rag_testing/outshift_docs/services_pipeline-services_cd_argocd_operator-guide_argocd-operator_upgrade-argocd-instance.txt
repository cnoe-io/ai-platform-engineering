Upgrade an existing ArgoCD instance using ArgoCD Operator
¶
Prerequisites
¶
ArgoCD is managed by ArgoCD Operator
Optional (when manually installed):
Kube context is set to
access the target cluster
1. Preparations
¶
Read carefully the
ArgoCD upgrade docs
and check if there is a breaking change that affect our
ArgoCD instances
.
First test the upgrade on the
ArgoCD Dev instance
.
If there is a possible breaking change, create a "test case" for it, use the
argocd-dev-platform-demo-deployment
made for this purpose.
2. [IMPORTANT - DO NOT SKIP] Backups
¶
2.1. Verify latest backup before you proceed
¶
Follow
these steps
to verify the latest backup is
current
and
can be decrypted
before you proceed.
2.2. Perform a manual backup
¶
Immediately before you upgrade the ArgoCD Operator and ArgoCD, perform a manual backup:
argocd login {ARGOCD_INSTANCE_DOMAIN} --sso
argocd admin export -n argocd -o argocd.prod.yaml
It can be useful to take a screenshot of the ArgoCD UI at the same time as the manual backup, especially the number of the Healthy/Degraded/Unknown applications on the left side to compare the applications' state after the upgrade.
3. Upgrade ArgoCD Operator
¶
New ArgoCD versions often require a new operator version.
Check the
Releases
page of the operator for newer versions and upgrade instructions.
Depending on how ArgoCD Operator
is installed
,
bump the version in the appropriate manifests and apply them according to the installation method.
4. Upgrade ArgoCD
¶
Check the
Releases
page of ArgoCD for a newer version.
Make sure it's compatible with the currently installed ArgoCD Operator.
Once you have the new version, follow these instructions:
Checkout the
argocd-instances
repository
Update
spec.version
in
TEAM/ENV/argocd.yaml
to the new version
Commit and push the changes
Apply the changes according to the
installation method
export
ARGOCD_TEAM
=
"sre"
export
ARGOCD_ENV
=
"dev"
export
NEW_ARGOCD_VERSION
=
"v2.2.5"
git
clone
git@wwwin-github.cisco.com:eti/argocd-instances.git
cd
argocd-instances
cd
$ARGOCD_TEAM
/
$ARGOCD_ENV
# Update the version in argocd.yaml
# Verify the ArgoCD version has been updated in the new manifest
kustomize
build
|
grep
${
NEW_ARGOCD_VERSION
}
git
add
.
git
commit
-m
"upgrade
$ARGOCD_TEAM
/
$ARGOCD_ENV
to
$NEW_ARGOCD_VERSION
"
git
push
If ArgoCD is installed manually:
kustomize
build
|
kubectl
apply
-f
-
5. Upgrading other ArgoCD components
¶
ArgoCD Operator supports additional ArgoCD components (right now, only ApplicationSet controller).
Check the
Releases
page of ArgoCD ApplicationSet controller.
Make sure to pick a version that's compatible with the ArgoCD version.
From
version 2.3
the ApplicationSet controller is bundled into the default Argo CD installation manifests - you don't need to do this step.
ArgoCD Operator Util
¶
ArgoCD exports currently attempt to create S3 buckets which (obviously) fails in a lot of cases.
There is a patched version of the util image that skips that step:
https://github.com/sagikazarmark/argocd-operator-util
Make sure to update ArgoCD Exports to use that image. Note that the image itself is versioned with the operator,
ArgoCD itself, so it needs to be updated with the operator.
Read more about the issue:
https://github.com/argoproj-labs/argocd-operator/issues/279
2023-09-21