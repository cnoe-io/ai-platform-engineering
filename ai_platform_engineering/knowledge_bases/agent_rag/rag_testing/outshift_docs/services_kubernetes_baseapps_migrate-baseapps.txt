migrate baseapps to new model
Migrate baseapps to new model
¶
0. Prerequisites
¶
Clone
sre-baseapps-configs
and change directory that repo
git
clone
git@github.com:cisco-eti/sre-baseapps-configs.git
export
SRE_BASEAPPS_CONFIGS_ROOT_DIR
=
"
$(
pwd
)
/sre-baseapps-configs"
cd
$SRE_BASEAPPS_CONFIGS_ROOT_DIR
Login to
argocd cli
first
Tip
argod admin password
If sso login to argocd doesn't work, try to login via admin user
argocd
login
argocd.prod.eticloud.io
--sso
Setup K8s context to target cluster
Tip
or
K8s Shell helper
export
CLUSTER_NAME
=
<your
cluster
name>
1. Reconciling a cluster to new baseapps model
¶
Send a notification to
Outshift Platform Status Webex Space
about the migration
# <cluster_name> base apps migration
**What:** SRE managed ArgoCD base apps are being migrated on <cluster_name>
**When:** <time of migration>
**Impact:** SRE managed ArgoCD apps might be restarted
Follow
Step 1
of installation guide to create baseapps folder for the cluster
Follow
Step 2
of installation guide to create instance configuration
Add all apps to exclude list
Apps can be excluded by adding
exclude: true
key-value pair for the application in
values.yaml
Currently available base apps are listed
here
under
baseapps:
key.
curl
https://wwwin-github.cisco.com/raw/eti/sre-helm-charts/main/kubernetes-baseapps/values.yaml
\
|
yq
'{"baseapps": ( .baseapps ) | del .[].* | .[].exclude=true}'
>
${
SRE_BASEAPPS_CONFIGS_ROOT_DIR
}
/clusters/
${
CLUSTER_NAME
}
/values.yaml
Follow
Step 3
of installation guide to create ArgoCD Project for the new baseapps configuration
Follow
Step 4
of installation guide to commit changes.
Migrate apps
App migrations can be done in small batches in the order of sync groups, starting with
syncGroup: "1"
Find apps belonging to the syncGroup under migration. syncGroups are listed
here
!!! tip
      For example syncGroup 1 has the following apps:
      eks-ebs-storage
      prometheus-operator-crds
      reloader
      sigstore-policy-controller
Open
${SRE_BASEAPPS_CONFIGS_ROOT_DIR}/clusters/${CLUSTER_NAME}/values.yaml
and remove apps under migration from exclude list
Find app configurations (
values.yaml
) in
sre-cluster-configs
repo,
   and copy the relevant config entries to
${SRE_BASEAPPS_CONFIGS_ROOT_DIR}/clusters/${CLUSTER_NAME}/<app_name>/values.yaml
You can figure out what needs to be copied by looking at the
values.yaml
of
generic examples
PR/Commit your changes in
sre-baseapps-configs
At this stage both
new
and
old
ArgoCD ApplicationSets are trying to manage ArgoCD resources.
Open
ArgoCD
and look for
${CLUSTER_NAME}-baseapps
application. It should show the migrated apps, and a degraded state as it unable
   to manage already existing resources belonging to the
old
ApplicationSet.
error while wrapping using MutateFn: Object argocd/eks-dev-3-external-secrets is already owned by another ApplicationSet controller external-secrets-appset
Remove
old
baseapps from
sre-cluster-configs
Remove cluster folder from each app under migration and PR/commit your changes.
Sync new applications
Repeat the following steps to sync changes
Open ArgoCD, navigate to one of the migrated apps and note resources creation time. This should NOT change during migration.
Run
Sync
If everything goes well, the new ApplicationSet should take over the apps without recreating resources.
!!! tip
       Sometimes ArgoCD sync can fail because new baseapps may try to install newer chart version. You may consider to manually remove degraded resources
       and let ArgoCD recreate them, but please keep in mind it could restart the application and have other possible side effects.
Verify migrated apps
${CLUSTER_NAMAE}-baseapps
ArgoCD project should be in sync
Migrated ArgoCD apps should be in sync
Follow
Step 5
of installation guide to validate migrated apps baseapps.
If everything is works as expected, you can repeat the process with the next sync group.
Send a notification to
Outshift Platform Status Webex Space
about the end of migration
2023-11-07