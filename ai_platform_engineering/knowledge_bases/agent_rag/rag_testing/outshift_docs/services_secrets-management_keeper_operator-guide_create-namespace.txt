create keeper vault namespace
Creating a namespace in Keeper
¶
SRE team uses gitops workflow to create a Keeper/Vault namespace with OIDC login
Pre-requisite
¶
Create Vault AD groups
AD Groups Format
eti-<TEAMNAME>-vault-admin
eti-<TEAMNAME>-vault-developer
Create a namespace
¶
The primary use case is for a sub-namespace for a venture, but can be applied to any namespace or sub-namespace. Note that sub-namespaces are distinct from their parent namespaces and require individual setup.
Create namespace using terraform
¶
This section describes creating a venture sub-namespace via terraform.
The terraform configuration also enables OIDC access via the
ETI CI CD Platform
myID SSO application.
Reference Code:
eticloud/apps/vowel
Clone
platform-terraform-infra
Create a PR for new namespace.
Reference Code
Use
atlantis workflow
to apply the change
Import existing namespace to terraform
¶
If the namespace already exists in Keeper, but was not created via terraform as described above, you can create the terraform configuration for it to start managing it as code by reconciling terraform's state with
terraform import
Warning
Before you run
terraform import
you must manually write a
resource
configuration block for the resource. The resource block describes where Terraform should map the imported object.
Note
Pre-requisites:
terraform
CLI installed on your local machine
Authenticated to the AWS account for the statefile bucket via
duo-sso
vault environment variables set, including your vault token:
export VAULT_NAMESPACE=eticloud
export VAULT_ADDR=https://keeper.cisco.com
export VAULT_TOKEN=<YOUR_TOKEN>
Run the following on your local machine in the directory of the terraform project. Replace
<NAMESPACE>
with the namespace you want to import (e.g.,
foresight
).
terraform
init
terraform
import
vault_namespace.namespace
<NAMESPACE>
If successful, you should see something like the following:
â
terraform
import
vault_namespace.namespace
foresight
vault_namespace.namespace:
Importing
from
ID
"foresight"
...
vault_namespace.namespace:
Import
prepared!
Prepared
vault_namespace
for
import
vault_namespace.namespace:
Refreshing
state...
[
id
=
foresight
]
data.vault_generic_secret.oidc_credential:
Reading...
data.vault_generic_secret.oidc_credential:
Read
complete
after
0s
[
id
=
secret/cisco_sso_auth_clients/vault_oidc_creds
]
Import
successful!
The
resources
that
were
imported
are
shown
above.
These
resources
are
now
in
your
Terraform
state
and
will
henceforth
be
managed
by
Terraform.
Run
terraform plan
and verify that the namespace is no longer planned to created. Other resources such as the oidc auth backend, role, and policies may be planned for creation.
Follow the usual atlantis workflow to plan and apply the changes.
Reference PR:
Adding
foresight
namespace after importing terraform state
(note that the first plan tries to create 8 resources, including the namespace, but the following plan triggered after
terraform import
excludes the namespace and only 7 resources are listed.)
Add Keeper token rotation. (Optional)
¶
This allows Jenkins to access the particular namespace for this particular venture.
sre-vault-token-rotation repo README
2024-06-07