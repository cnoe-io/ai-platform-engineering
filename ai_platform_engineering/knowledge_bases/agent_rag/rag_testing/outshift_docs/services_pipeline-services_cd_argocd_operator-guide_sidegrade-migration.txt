Sidegrade migration
¶
Notify the relevant teams upfront and when the migration starts.
Preparations
¶
Add the new domain (redirect URI) to the OAuth app
Create a new cisco-sso-migration secret in Keeper (based on the existing cisco-sso) with the updated redirect URI
Grab the LoadBalancer IP from Openstack
Point the new domain to the right LoadBalancer in AWS Route53
Installation
¶
Install the
argocd-operator
to the new cluster
Create a new migration kustomization directory from the existing with the following content:
kustomization.yaml
:
apiVersion
:
kustomize.config.k8s.io/v1beta1
kind
:
Kustomization
namespace
:
argocd
resources
:
-
../prod/
patchesStrategicMerge
:
-
argocd.yaml
-
external-secret.yaml
argocd.yaml
:
 ```yaml
apiVersion: argoproj.io/v1alpha1
kind: ArgoCD
metadata:
  name: argocd
spec:
  server:
    host: NEW_HOST
    ingress:
      tls:
        - hosts:
            - ORIG_HOST
          secretName: argocd-tls
        - hosts:
            - NEW_HOST
          secretName: argocd-temp-tls
3. `external-secret.yaml`:
```yaml
apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
name: argocd-dex
spec:
dataFrom:
- key: argocd/TEAM/ENV/cisco-sso-migration
Install ArgoCD:
kustomize build | kubectl apply -f -
Migrate content to the new instance:
Export from the old cluster (requires kube context):
argocd admin export -n argocd > backup.yaml
Prune the following manifests
ConfigMap argocd-cm
Secret argocd-default-cluster-config
ConfigMap argocd-ssh-known-hosts-cm
Secret argocd-secret
ConfigMap argocd-tls-certs-cm
ConfigMap argocd-rbac-cm
Import into the new cluster (requires kube context):
argocd admin import -n argocd - < backup.yaml
Flip DNS
Apply the original ArgoCD manifests to the new cluster:
kustomize build | kubectl apply -f -
Scale down argocd-operator on the old cluster:
kubectl -n argocd-operator-system scale deploy --all --replicas 0
Note: you may have to disable synchronization if you installed the ArgoCD operator with ArgoCD
Scale down ArgoCD on the old cluster:
kubectl -n argocd-operator scale deploy --all --replicas 0
TODO: update argocd manifest to scale down everything
Cleanup
Delete the migration folder with manifests
Delete the cisco-sso-migration secret from keeper
Delete the old ArgoCD installation
2023-01-27