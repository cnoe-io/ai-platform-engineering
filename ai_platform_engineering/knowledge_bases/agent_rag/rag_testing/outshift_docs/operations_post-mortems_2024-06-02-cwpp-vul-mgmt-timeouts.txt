cwpp-vul-mgmt service timeouts
post mortem
2024-06-02; cwpp-vul-mgmt service timeouts
¶
Summary
¶
cwpp-vul-mgmt service the two different clusters and times had timeouts and was partially inaccessible.
When
¶
2024-06-02
Timeline
¶
2024-05-30 (Thursday) - Creating cwpp-prod-us cluster in region us-east-1 installing sre-baseapps and canary test went successfully in new cluster both internal and external ingress-nginx.
2024-05-30 (Thursday) - Moving cwpp-vul-mgmt application from us-east-2 to us-east-1.
2024-05-30 (Thursday) - removing old cluster.
2024-06-02 (Sunday) - 0903 - Maor Levi opened a ticket to cwpp team explaining that our application "API randomly fails with 504 / getting timeouts/ works very slowly".
2024-06-02 (Sunday) - 1200 - After investigation and verifying the issue, timeouts are inconsistent and when happening there are no logs in nginx pods, restart the ingress-nginx-application didn't change the status.
2024-06-02 (Sunday) - 1315 - Updating ingress nginx version to 4.10.0-1.
2024-06-02 (Sunday) - 1341 - SRE team is beeing involved and start investigation on the issue.
2024-06-03 (Sunday) - 0700 - Incident space in opened in webex.
2024-06-03 (Monday) - 1000 - A workaround solutions considerations, a new cluster is begging to provisioned.
2024-05-06 (Monday) - 1215 - A new workaround fix is executed and all the traffic is now routed to EU region
2024-06-03 (Monday) - 1855 - A new cluster with newer baseapps version is up and running with the application which is fully accessible.
2024-06-03 (Monday) - 2055 - Maor levi confirms service accessible
2024-06-13 (Thursday) - 1746 - The same issue is occurring the EU region (which was stable) with less timeouts.
2024-06-16 (Sunday) - The Issue is investigated during the day:
                      - Internal nginx did not face the issue although having same configurations.
                      - reducing the number of replicas to 1 fixed the issue.
                      - no connectivity/networking issue was discovered during the investigation process.
                      - kind ingress configurations was disqualified as we removed the cwpp-vul-mgmt from eu for testing canary, and faced the same behavior.
                      - all of the above led us into a conclusion that all nginx-ingress pods must use the same node group, adding node group selector stabilized the application.
Impact
¶
System(s) impacted?
¶
Code & Build
Teams impacted?
¶
Code & Build
external customers.
Analysis
¶
Migration of the cwpp-vul-mgmt application from the us-east-2 to us-east-1 region and the removal of the old cluster were pivotal events. This suggests that the infrastructure change could have been the trigger for the timeouts experienced later, although the issue has happened again spontaneously in EU region.
The absence of Nginx pod logs during the timeouts suggests that the root cause was networking/connections issue.
Updating the ingress Nginx version did not alleviate the problem, suggesting that the timeouts were not due to the specific Nginx version.
The move to provision a new cluster and reroute traffic indicated a suspected issue with the original cluster's setup or regional configuration.
The discovery that reducing replicas to one solved the problem points to a potential issue with load distribution or pod-to-pod communication.
The persistent issue after removing the cwpp-vul-mgmt from the EU region for testing indicated that the problem was not nginx configurations.
The resolution involving the use of a consistent node group for all Nginx-ingress pods suggests an underlying issue with cross-node networking or scheduling.
Takeaways
¶
When changing infrastructure deep testing is required
Enhancing monitoring and logging of the service is needed
Strategic node group utilization when using nginx in multi nodegroup cluster.
Importance of disaster recovery planning when switching to EU region which could be preformed in earlier stage
Coordination and communication during incidents was good but could be better with more updates in realtime in the incident space.
2024-06-23