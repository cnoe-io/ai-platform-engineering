How to fix the Persistant Volume issue in P3
¶
In this doc we will go over the steps taken to fix the issue with the Atlantis PVC in P3.
Problem
Solution
Problem
¶
Sometimes after restarting the RS(Replica Set) of Atlantis in ArgoCD, the PVC(Persistant Volume Claim) will not be able to mount to the pod. This is because the PVC is already bound to the pod that was previously running. This is a known issue with Kubernetes and there is no way to fix it without deleting the PVC. After deleting the PVC, ArgoCD will try to recreate a new PVC. However, the new PVC errors out because it is unable to allocate sufficient resources in OpenStack. This is because the PVC is trying to allocate 100GB of storage, but there is only
X
GB of storage available in the OpenStack cluster.
Example:
ArgoCD:
In Openstack:
Solution
¶
In order to fix this issue, we need to first investigate the current state in
Openstack
and remove any unused resources. The steps below will go over how to do this.
We should first make sure that the volumes are not being filled up in the cluster node(s) themselves. To do this, we can access the cluster following the instructions
here
for
eti-gitops-3
(where the Atlantis instance is currently installed).
Once we are in the cluster node(s), we can check the status of the volumes by running the following command:
du
-cha
--max-depth
=
1
<directory/folder>
|
sort
-hr
|
grep
-E
"M|G"
Login to Openstack and go to the
Overview
page.
Note
Take note of the current status of the overall resources, especially the volume storage.
If the above is reaching a limit, we should delete any unused resources. To do this, go to the
Volumes
page and delete any unused volumes.
Example:
2023-10-26