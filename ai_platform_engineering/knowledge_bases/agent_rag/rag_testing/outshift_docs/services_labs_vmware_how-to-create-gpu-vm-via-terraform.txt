GPU
Terraform
vsphere
How to create GPU VM with Terraform in vSphere
¶
vSphere GPU VM provisioning with Terraform offers a streamlined workflow for automating the creation and management of GPU virtual machines(VMs) within a vSphere environment.
Here is a summary of the vSphere GPU VM provisioning steps.
VMware Data Center information
How to provision a GPU VM
Step 1: Clone the
sre-vmware-sandbox
Repo
Step 2: Make Changes to Configure the Desired VM Specs
Step 3: set vault environment variables
Step 4: run terraform locally
Step 5: Add the VM Information to eti-inventory
VMware Data Center information
¶
GPU-equipped  VMware environments:
SJC-09 vCenter
How to provision a GPU VM
¶
Step 1: Clone the
sre-vmware-sandbox
Repo
¶
git
clone
https://wwwin-github.cisco.com/eti/sre-vmware-sandbox.git
Step 2: Make Changes to Configure the Desired VM Specs
¶
Navigate to
/datacenter/eti-sj9-dc/eti-sj9-cluster/gpu/
Make a copy from any existing vm tf file and rename it based on your new vm-name.\
Example
.
Edit the file; in the
sre-vmware-module
section, configure the desired VM specs, such as CPU, Memory, etc.
Additional vm specs that need to be specified:
gpu-host
and
vm-datastore
: refer ESXi host information
here
.
regex-name
: options,
TU104GL
for T4s and
20B5
for the A100s.
pci-device-id
:  check the available
pci-device-ids
for each host . Make sure its not in the used
list
.
pciPassthruSize
: for Tesla T4s use 64 and for the A100s use 256"
Change the S3 backend key/value based on your instance name.
For example:
terraform
{
backend
"s3"
{
bucket
=
"tfstate-vmware-sjc"
key
=
"tfstate-build/[instance-name].tfstate"
region
=
"us-east-2"
}
}
Step 3: set vault environment variables
¶
Since Atlantis for the labs is not currently operational [WIP], you can run terraform on your local machine.
Make sure that
terraform
CLI installed on your local machine.
Authenticated to the AWS account for the statefile bucket via
duo-sso
vault environment variables set, including your vault token:
export
VAULT_NAMESPACE
=
eticloud/eticcprod
export
VAULT_ADDR
=
https://keeper.cisco.com
export
VAULT_TOKEN
=
<YOUR_TOKEN>
Step 4: run terraform locally
¶
terraform
init
terraform
plan
terraform
apply
- You can find the credentials of the new created VM in
Vault
.
Step 5: Add the VM Information to eti-inventory
¶
After creating the VM, be sure to add the resource's information to
racktables
. The credentials are available in
Vault
.
2023-08-29