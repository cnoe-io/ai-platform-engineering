SRE-1096 (2): ciscotechblog.com trailing slash fix roll-out
¶
Revised solution for resolving
SRE-1096
in production.
SRE-1096 (2): ciscotechblog.com trailing slash fix roll-out
Preparation Steps
Execute Change
Roll-out Nginx Configuration Change
Re-enable Blue-Green deploys for Production
Post-Validation
Validate nginx change
Validate re-enabling of blue-green deploys in production
Roll-Back
Preparation Steps
¶
Create a PR (do
not
merge yet) to bump Chart version to and remove unnecessary overlay values for production
https://wwwin-github.cisco.com/eti/techblog-website-deployment/pull/21
Execute Change
¶
Post notice in the
ET&I Platform Status
space about this change
Roll-out Nginx Configuration Change
¶
Merge the PR to bump helm Chart version to 1.0.7 in production that was created in the
Preparation Steps
.
Go to the production
techblog app project in ArgoCD
and trigger a
Sync
for each deployed application
Verify that the Ingress update succeeds:
Green heart in ArgoCD
ciscotechblog.com
no longer present in the SAN list in the certificate served by each internal url:
https://techblog-blue-a.prod.ciscotechblog.com/
https://techblog-blue-b.prod.ciscotechblog.com/
<!--
Removed. Green not deployed.
https://techblog-green-a.prod.ciscotechblog.com/
https://techblog-green-b.prod.ciscotechblog.com/
→
Run the
prod deploy job
with the latest version of the application to roll-out the
nginx config change
Copy the
Build version
from the latest successful deploy to staging
here
Click on "Build with Parameters" in the
deploy job
, paste copied version into the
APP_CONTAINER_VERSION
field, and click
Build
Validate the nginx config change
Re-enable Blue-Green deploys for Production
¶
Create a PR to revert
this commit
to restore blue-green deploys for production (
git revert e3c65a555e4e6b4592a0ed0b43f3b87b9f5ee67a
)
!!! Important !!!:
Make the following updates to the reverted files:
update
ciscotechblog.tagversion
value in
overlays
with the latest app version in current
master
branch
update the helm Chart versions for green environment to be the latest (
1.0.7
)
remove
skipBlueGreenDeployment: true
under
prod
in
Jenkinsfile
Merge the above PR
Trigger a
production deploy job
with the last successfully deployed application version
Validate the blue-green deploy re-enablement
Post-Validation
¶
Validate nginx change
¶
Open a web browser, clear history and cookies, and enable developer tools. Navigate to:
https://techblog-blue-a.prod.ciscotechblog.com/blog/introducing-media-streaming-mesh
Verify that there are no
301
responses in the captured network requests:
Open a web browser, clear history and cookies, and enable developer tools. Navigate to:
https://techblog.cisco.com/blog/introducing-media-streaming-mesh
Verify that there are no
301
responses in the captured network requests
the domain in the browser remains
techblog.cisco.com
(i.e., does
not
redirect to a
techblog-blue-a.prod.ciscotechblog.com
internal url)
Validate re-enabling of blue-green deploys in production
¶
Verify that the deploy job successfully completes
Verify that CloudFront
origins
now points at the "green" sites
Post update in the
ET&I Platform Status
space that this change roll-out is complete.
Roll-Back
¶
If the
https://ciscotechblog.com
page fails to load after the change, immediately roll back the changes:
* Run the
prod deploy job
with the previously deployed application version
* If the above step does not restore service, also roll-back the Helm Chart version bump:
    * Revert
this PR
2023-10-16