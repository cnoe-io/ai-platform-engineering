Force delete K8S Namespace
¶
**In order to Forcibly delete K8S namespaces that are stuck in "terminating" status use the following one-liner.
It opens a kubectl proxy, iterates on all "terminating" namespaces, creates a $NS.json for each, modify each by deleting the finalizers array, push back to the cluster respectively, using the proxy.
Steps
¶
Make sure your kube context is set to the currect cluster and you got access to the relevant cloud account (AWS duo-sso or gcloud)
Run the following command:
kubectl
proxy
--port
=
8001
&
for
ns
in
$(
kubectl
get
namespaces
--field-selector
=
status.phase
=
Terminating
-o
\
jsonpath
=
'{.items[*].metadata.name}'
)
;
do
kubectl
get
namespace
$ns
-o
json
|
jq
'.spec.finalizers=[]'
>
\
$ns
.modified.json
&&
curl
-k
-H
"Content-Type: application/json"
-X
PUT
--data-binary
@
$ns
.modified.json
\
http://127.0.0.1:8001/api/v1/namespaces/
$ns
/finalize
&&
rm
$ns
.modified.json
;
done
&&
kill
%1
The command will automatically delete all $NS.json created and close the proxy
2023-11-01