Setting up a GitHub repository for Atlantis
¶
Table of Contents
¶
Setting up the webhook
From CLI
From the UI
Atlantis repository access
Atlantis configuration
Setting up the webhook
¶
From CLI
¶
Prerequisites:
GitHub CLI
JQ
Vault CLI
Checkout the repository locally and run the following command in its directory:
echo
'{
"name": "web",
"active": true,
"events": [
"issue_comment",
"pull_request",
"pull_request_review",
"push"
],
"config": {
"content_type": "form",
"insecure_ssl": "0",
"secret": "",
"url": "https://atlantis.prod.eticloud.io/events"
}
}'
|
jq
-r
".config.secret=\"
$(
vault
kv
get
-namespace
=
eticloud
-field
=
github_secret
secret/atlantis/github
)
\""
|
gh
api
-X
POST
--input
-
repos/
{
owner
}
/
{
repo
}
/hooks
If everything goes well, you should see a similar payload in the response.
Verify that the response contains a
secret
field under the
config
key.
If it doesn't, fetching the secret from Keeper might have failed.
If something goes wrong, you can list the registered hooks using the following command:
gh
api
repos/
{
owner
}
/
{
repo
}
/hooks
Delete any improperly registered hooks with the following command:
gh
api
-X
DELETE
repos/
{
owner
}
/
{
repo
}
/hooks/HOOK_ID
From the UI
¶
Go to the hook settings of the repository (generally
https://wwwin-github.cisco.com/eti/YOUR_REPOSITORY/settings/hooks
)
Click
Add webhook
On the next page fill in the form:
Payload URL:
https://atlantis.prod.eticloud.io/events
Content type:
application/x-www-form-urlencoded
Enable SSL Verification
Secret
Login to
Keeper
(namespace:
eticloud
)
From the UI
Copy
github_secret
field from
secret/atlantis/github
From CLI
vault
kv
get
-namespace
=
eticloud
-field
=
github_secret
secret/atlantis/github
|
pbcopy
- _Which events should you like to trigger with this webhook?_ (Select _Let me select individual events_):
    - Issue comments
    - Pull requests
    - Pull request reviews
    - Pushes
- Ensure _Active_ is checked
Click
Add webhook
TODO: Customers should be able to onboard themselves to Atlantis? Currently, only SRE can onboard a repository.
Atlantis repository access
¶
In order to allow Atlantis automatically merging PRs the
eti-atlantis-gen
needs
Write
access to the repository.
Note: In the new GitHub permission system that replaced the old (Read/Write/Admin)
Write
access is called
push
in the API.
Within the
eti
organization the easiest was to achieve this is adding the
eti_sre_bots
team to the repository:
gh
api
-X
PUT
orgs/
{
owner
}
/teams/eti_sre_bots/repos/
{
owner
}
/
{
repo
}
-F
'permission=push'
TODO: this section should be publicly for anyone using Terraform and Atlantis.
Atlantis configuration
¶
See
Atlantis.yaml
for more details.
Once the atlantis.yaml file is created, you can add Terraform files
2023-10-26