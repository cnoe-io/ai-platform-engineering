aws setup mfa on root account
create new aws account
Creating a new AWS account in RunON
¶
Overview
¶
RunOn
is the one-stop shop for Cisco employees to find, learn, choose, and run cloud infrastructure.  We use it to manage the internal Openstack P3, as well as cloud, AWS and GCP.
Prerequisites
¶
AWS Account Name (
eticloud-example
used for documentation)
A list of owners and users for this AWS account.
SRE RunON tenant owner permissions.
Budget approval for additional AWS account within tenant.
Note
Please reference
this confluence page
and only create cloud accounts in the tenants that correspond to the project. Reachout to Sri Aradhyula (
sraradhy@cisco.com
) or Carole Reynaud (
creynaud@cisco.com
) if you have any questions on budget per cloud account or which tenant to use.
Account Creation Steps
¶
1. Create Cisco Mailer (e-mail distribution list)
¶
Create a
Cisco mailer
distribution list to use as the root AWS account e-mail.
Use
<account-name>-root
for the distribution group name.
Example:
genai-common-root
Add the owners and members
Owners:
adrozdov
ahismail
daboucha
dneduva
gbouline
haskalpa
hkhoury
imangass
jawren
mfinkels
mshoosht
mouledel
petersz
sraradhy
subbaksh
yovsyann
Members:
adrozdov
ahismail
daboucha
dneduva
gbouline
haskalpa
hkhoury
imangass
jawren
mfinkels
mshoosht
mouledel
petersz
sraradhy
subbaksh
yovsyann
Use the following setup option
Use following screenshot as an example for setting the owner, members and attributes.
Note: RunOn limits the membership of this group to 5 individuals. Exceeding this will result in an error during account creation.
The mailer can take some time to propagate so this is a good time to take a break.
2. Create AWS Cloud Account in RunOn
¶
Once the mailer is available (the SRE group will receive an email notification when that is the case), create the account by navigating to the
AWS Cloud account tab
.
On this page, click the
create cloud account
button to bring up the account creation form.
If there are any budget related issues preventing from creating this new account, you will see the below screenshot:
Sync with the SRE leads in order to adjust budget and/or remove unused AWS acccounts.
Enter the account name and account root email address created earlier in the fields below.
If the email is not yet propagated, you would see the following error in red.
If the email alias includes more than 5 members, you will see a warning that the recommended member size is 5, but proceed regardless.
Complete the remainder of the form as shown below
Once the form data is updated, select create account and you should see the following dialog.
3. Set Root User Password
¶
Logout of your existing AWS session
Log into the
AWS Console
Select Root User, and enter the e-mail address created for the root user.
Choose forgot password
Navigate through CAPTCHA.
Generated complex password on command line
Command line
LC_ALL=C tr -dc 'A-Za-z0-9!#%=?@^_`{|}~' </dev/urandom | head -c 24
Store the password from the above step in
keeper
Navigate to the
eticloud/teamsecrets
namespace within
Keeper
.
Create a new secret for the account
eti-cloud-example
in path
secret/aws/<aws account name>/root
Store
user
with the value of the account root e-mail address.
Store
password
from the above step
Check for a password reset e-mail from AWS and follow the link.
Note
Password reset email is only sent to the owners of the account as specified in the Cisco mailing list
Use the password from
Step 8
to set the new password
4. Set up MFA on Root User
¶
Log into the
AWS Console
setup in the previous step
Note
Security updates: Runon has removed privileges on root account, so when you try to login to
AWS Console
using Root User, you will see some permission errors as detailed below.
Navigate to IAM Dashboard
Look for
MFA
on the
IAM Dashboard page
and click on
My security credentials
Click on
Assign MFA device
Specify
duo-sso
and use
Authenticator app
Click on
Show secret key
Save the MFA secret in the
Keeper path
as above step for offline MFA setup by team members.
Offline MFA setup guide
Store
MFA
from the above step
Show QR code to finish MFA setup
Open "Duo Mobile" on your phone
Add new authenticator
Scan QR code from the above step
Enter
MFA code 1
and
MFA code 2
from duo to AWS MFA console
After both MFA codes are entered. MFA is setup is successful as shown below
Test MFA by logging out and logging in with root user credentials from above
5. Add SRE team members as admin
¶
Runon automatically creates admin and devops groups via their automation. We should check if the creation has been done successfuly:
Navigate to
myid-groups
and verify if
AWS-ACCOUNT_ID-admin
and
AWS-ACCOUNT_ID-devops
groups associated to the new AWS account has been created. you could find
AWS ACCOUNT_ID
here
Please sync myid-groups and our sre-cisco-groups-automation repository by following
this doc
Verify if jenkins job has been successfuly executed (sync is ok).
In
sre-cisco-groups-automation
repo verify automation added the members of the SRE team as admins. Venture team members should be part of the
member_users
list, not
owner_users
. See
this documentation
for additional details on lists.
6. Set Account Alias
¶
Log in
AWS SAML
using the admin IAM Role and set the Alias for the account.
Navigate to IAM dashboard.
Setup account alias on the right side of the dashboard.
In case the alias is already in use, you will see the below error:
Refer to the
AWS documentation
, check if any other AWS account is using that alias, and choose a different alias if need be
Setup Terraform Admin user for Atlantis
¶
Create
Terraform Admin user
to enable Atlantis automation.
Update documentation
¶
Note
â¼ï¸
This step is important
â¼ï¸
AWS Accounts docs
Duo-sso Profiles in sre-utilities
2024-07-18