Installation
¶
Installing the operator
¶
The first step to install Harbor on a Kubernetes cluster is making sure
Harbor Operator
is installed.
Go to the
sre-cluster-configs
repository and check if it's already installed.
If not, find the latest Harbor version under
sre/_apps/harbor-operator/versions
and configure it for the target cluster.
export
CLUSTER_NAME
=
my-cluster-1
export
HARBOR_OPERATOR_VERSION
=
1
.3.0
git
clone
git@wwwin-github.cisco.com:eti/sre-cluster-configs.git
git
checkout
-b
install-harbor-operator-
$CLUSTER_NAME
cd
sre-cluster-configs
cd
sre/harbor-operator
mkdir
$CLUSTER_NAME
cd
$CLUSTER_NAME
# Link the cluster config
ln
-s
../../_cluster-config/
$CLUSTER_NAME
/config.json
# Create kustomization.yaml
cat
<< EOF > kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ../../_apps/harbor-operator/versions/$HARBOR_OPERATOR_VERSION
EOF
# Test changes
kustomize
build
# Commit and push changes
git
add
.
git
commit
-m
'install harbor-operator on $CLUSTER_NAME'
git
push
-u
origin
install-harbor-operator-
$CLUSTER_NAME
# Create a pull-request
open
https://wwwin-github.cisco.com/eti/sre-cluster-configs/pull/new/install-harbor-operator-
$CLUSTER_NAME
Installing Harbor
¶
Create a new instance in the
harbor-instances
repository.
Take a look at the existing examples for inspiration.
Apply the manifests manually (for now) to the cluster:
kustomize
build
path/to/instance
|
kubectl
apply
-f
-
Mark is our SME on Harbor, so feel free to reach out to him in case you are tasked with installing/upgrading Harbor.
The old way
¶
helm
upgrade
--install
harbor
harbor/harbor
-n
harbor
--create-namespace
--set
harborAdminPassword
=
"any_password!"
--set
expose.ingress.hosts.core
=
harbor.eticloud.io
--set
expose.ingress.hosts.notary
=
notary.harbor.eticloud.io
Once installed, you will need to modify the ConfigMap for core:
kubectl
-n
harbor
edit
cm
harbor-harbor-core
Modify theÂ EXT_ENDPOINT:
https://harbor.eticloud.io
Adding OIDC support
¶
First,
register a new OAuth client
in Cisco's Policy Management tool.
Next, save the client secret key in Keeper and enter it in the OIDC configuration in Harbor.
with parameters:
Auth Mode: OIDC
OIDC Provider Name: cloudsso.cisco.com
OIDC Endpoint:
https://cloudsso.cisco.com
OIDC Client ID: eti-
-
-
OIDC Client Secret: use the one created on the
previous step: register a new OAuth client
Group Claim Name: memberOf
OIDC Scope: openid,email,profile
Verify Certificate:
should be checked
Automatic onboarding:
should be checked
Username Claim: sub
2023-05-27