# Architecture Decision Records (ADR) - Cursor Rules

## Purpose
This directory contains ADRs documenting significant changes, features, and design decisions for ai-platform-engineering (Backend AI Agent System). These records provide historical context and rationale for architectural choices.

## ADR Format (REQUIRED)

Every ADR MUST follow this exact structure:

```markdown
# ADR: [Title]

**Status**: ðŸŸ¢ In-use | ðŸŸ¡ Proposal | ðŸ”´ Abandoned
**Category**: [Architecture & Design | Features & Enhancements | Bug Fixes & Performance | Documentation]
**Date**: Month DD, YYYY
**Signed-off-by**: Name <email>

## Overview / Summary
[1-2 paragraph summary of what was changed/implemented]

## Problem / Problem Statement
[What problem was being solved? What was the root cause?]

## Solution / Solution Design / Implementation
[How was the problem solved? What approach was taken? Code examples]

## Benefits
[Why this change matters, what improvements it brings]

## Testing / Verification
[How to verify the change works, test cases, integration tests]

## Files Modified
[List of files that were changed with paths]

## Related Documentation
[Links to related ADRs, frontend docs, external references]

---
```

## Status Indicators

### ðŸŸ¢ In-use
- Feature/decision is **actively implemented** and **in production**
- Code is present and functional in the codebase
- Must be verified against actual Python code before marking as in-use
- Agent is deployed and handling requests

### ðŸŸ¡ Proposal
- Feature/decision is **proposed** but **not yet implemented**
- Use for design proposals and planned features
- Should include implementation timeline
- Include rationale and alternatives considered

### ðŸ”´ Abandoned
- Feature/decision was **implemented but later removed** OR **proposed but rejected**
- Must include reason for abandonment
- Keep for historical context
- Reference replacement solution if any

## Rules for Creating/Updating ADRs

### 1. Verify Before Marking Status
**CRITICAL**: Before marking an ADR as ðŸŸ¢ In-use:
- âœ… Search the codebase for mentioned functions/classes/agents
- âœ… Verify the code is actually being used (not commented out)
- âœ… Check agent is deployed (docker-compose or Helm)
- âœ… Verify integration tests pass
- âœ… Confirm the feature works in production

Example verification:
```bash
# Search for function/class usage
grep -r "class ArgocdAgent" ai_platform_engineering/

# Check MCP server implementation
find ai_platform_engineering/agents/argocd/mcp -name "*.py"

# Verify agent deployment
grep -r "argocd" docker-compose/

# Run integration tests
pytest integration/test_platform_engineer_executor.py
```

### 2. File Naming Convention
- Format: `YYYY-MM-DD-descriptive-title.md`
- Use lowercase with hyphens
- Be descriptive but concise
- Example: `2025-11-05-argocd-oom-protection.md`

### 3. Categories

**Architecture & Design**
- Multi-agent system architecture
- Supervisor patterns
- State management approaches
- LangGraph implementations
- A2A protocol design

**Features & Enhancements**
- New agent implementations
- MCP server additions
- Tool implementations
- Performance optimizations
- Context management features

**Bug Fixes & Performance**
- Critical bug fixes
- OOM protections
- Memory optimizations
- Race condition fixes

**Documentation**
- Setup guides
- Integration guides
- API documentation

### 4. When to Create an ADR

Create an ADR when:
- âœ… Implementing a new agent (ArgoCD, AWS, Jira, etc.)
- âœ… Making architectural decisions (supervisor vs direct routing)
- âœ… Fixing critical bugs (OOM, race conditions, streaming issues)
- âœ… Adding A2A protocol features
- âœ… Implementing MCP servers
- âœ… Performance optimizations (pagination, caching)
- âœ… Context management strategies

Do NOT create an ADR for:
- âŒ Minor bug fixes
- âŒ Dependency updates (unless significant)
- âŒ Code formatting changes
- âŒ Configuration tweaks

### 5. Code Examples in ADRs

Always include:
- **Location comments**: Specify file path and function/class
- **Context**: Show before/after comparisons for changes
- **Complete examples**: Include enough Python code to understand
- **Language tags**: Use `python` syntax highlighting

Example:
```python
# File: ai_platform_engineering/agents/argocd/mcp/mcp_argocd/tools/api_v1_applications.py

def list_applications(
    page: int = 1,
    page_size: int = 20
) -> Dict[str, Any]:
    """List ArgoCD applications with pagination.

    Args:
        page: Page number (1-indexed)
        page_size: Items per page (default 20, max 100)

    Returns:
        Dictionary with items and pagination metadata
    """
    # Fetch from ArgoCD API
    all_apps = argocd_client.list_applications()

    # Calculate pagination
    total_items = len(all_apps)
    total_pages = (total_items + page_size - 1) // page_size
    start_idx = (page - 1) * page_size
    end_idx = start_idx + page_size

    return {
        "items": all_apps[start_idx:end_idx],
        "pagination": {
            "page": page,
            "page_size": page_size,
            "total_items": total_items,
            "total_pages": total_pages
        }
    }
```

### 6. Backend-Specific Considerations

**Agent Implementations**:
- Document system prompts and their rationale
- Show LangGraph state definitions
- Explain routing decisions
- Include tool definitions

**Multi-Agent System**:
- Document supervisor routing logic
- Show sub-agent communication patterns
- Explain delegation strategies
- Include execution plan formats

**A2A Protocol**:
- Show artifact structure
- Document event types
- Explain streaming behavior
- Include protocol compliance

**MCP Servers**:
- Document server endpoints
- Show tool definitions
- Explain resource management
- Include pagination strategies

### 7. Updating Existing ADRs

When code changes affect an ADR:

**If feature is enhanced:**
- Update the Implementation section
- Add note about enhancement with date
- Keep Status as ðŸŸ¢ In-use

**If feature is deprecated:**
- Change Status to ðŸ”´ Abandoned
- Add "Deprecation" section explaining why
- Document replacement solution if any

**If agent is replaced:**
- Change Status to ðŸ”´ Abandoned
- Reference the new ADR that replaces it
- Keep original for historical context

### 8. Cross-References

Always link to:
- Related backend ADRs
- Frontend ADRs (agent-forge, agent-chat-cli)
- A2A protocol documentation
- LangGraph/LangChain docs

Example:
```markdown
## Related Documentation

- [Agent-Forge Artifact Handling](../../../../../community-plugins/workspaces/agent-forge/docs/docs/changes/2025-11-05-a2a-artifact-based-streaming.md)
- [Agent-Chat-CLI Partial Results](../../../../../agent-chat-cli/docs/docs/changes/2025-11-07-streaming-behavior.md)
- [A2A Protocol Spec](https://github.com/ModelContextProtocol/a2a-spec)
```

### 9. Testing Section

For backend ADRs, include:
- **Integration Tests**: Paths to test files
- **Manual Testing**: Steps to verify manually
- **Performance Testing**: Memory/latency measurements
- **Test Scenarios**: Real-world usage patterns

Example:
```markdown
## Testing

### Integration Tests

Run the platform engineer executor tests:
```bash
pytest integration/test_platform_engineer_executor.py -v
```

### Manual Testing

1. Start ArgoCD agent:
```bash
docker-compose -f docker-compose/docker-compose.argocd.yaml up
```

2. Send test query:
```bash
curl -X POST http://localhost:8000/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "list applications page 1"}'
```

3. Verify pagination in response

### Performance Testing

- Memory usage: < 500 MB for 20 items
- Response time: < 2 seconds
- No OOM with 819 total applications
```
```

### 10. Verification Section (Required for ðŸŸ¢ In-use)

Every In-use ADR MUST include verification:

```markdown
## Verification

Code analysis confirms these features are **actively in use**:
- âœ… `list_applications()` function in `tools/api_v1_applications.py`
- âœ… Pagination parameters implemented (page, page_size)
- âœ… Agent deployed in `docker-compose.argocd.yaml`
- âœ… Integration test passing: `test_platform_engineer_executor.py`
- âœ… Feature verified in production environment
```

### 11. Architecture Diagrams

Use ASCII art or mermaid diagrams when helpful:

```
Multi-Agent Architecture:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Platform Engineer Supervisor           â”‚
â”‚  - Routes to specialized agents          â”‚
â”‚  - Manages execution plan                â”‚
â”‚  - Aggregates responses                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€> ArgoCD Agent
           â”‚    - List applications
           â”‚    - Search resources
           â”‚    - Manage deployments
           â”‚
           â”œâ”€â”€> AWS Agent
           â”‚    - List resources
           â”‚    - Manage services
           â”‚    - Cost analysis
           â”‚
           â””â”€â”€> Jira Agent
                - Create issues
                - Search tickets
                - Update status
```

### 12. Performance Metrics

Document performance impact:

```markdown
## Performance Impact

### Before
- Memory: 2.5 GB (819 apps loaded)
- Response time: 45 seconds (OOM timeout)
- Success rate: 60% (40% OOM killed)

### After (with pagination)
- Memory: 480 MB (20 apps per page)
- Response time: 2 seconds
- Success rate: 100%
- Improvement: 80% memory reduction
```

### 13. Maintenance

**Monthly Review**:
- Verify all ðŸŸ¢ In-use ADRs are still accurate
- Check for deprecated agents
- Update performance metrics
- Verify integration tests still pass

**Code Changes**:
- When modifying agent code, update corresponding ADR
- Keep implementation details synchronized
- Update file paths if code moves

## Quick Checklist for New ADRs

Before committing a new ADR:
- [ ] Title starts with "ADR:"
- [ ] Status indicator (ðŸŸ¢/ðŸŸ¡/ðŸ”´) is present
- [ ] Category is specified
- [ ] Date is included
- [ ] Signed-off-by line is present
- [ ] All required sections are included
- [ ] Code examples have file paths
- [ ] Python code is properly formatted
- [ ] If Status is ðŸŸ¢ In-use: Verification section is included
- [ ] Integration tests referenced
- [ ] Performance impact documented (if applicable)
- [ ] Related frontend ADRs cross-referenced
- [ ] File name follows YYYY-MM-DD-title.md format
- [ ] README.md is updated with new ADR entry

## Examples

See existing ADRs in this directory:
- `2025-11-05-argocd-oom-protection-summary.md` - Architecture decision
- `2025-11-05-mcp-argocd-pagination-summary.md` - Feature implementation
- `2025-11-05-a2a-artifact-streaming-fix.md` - Bug fix

## Contact

For questions about ADR format or content:
- Platform Engineering Team
- Sri Aradhyula <sraradhy@cisco.com>
